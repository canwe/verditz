<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html dir='ltr'>
  <head>
    
  <meta content='text/html; charset=UTF-8' http-equiv='Content-Type'/>
  <meta content='true' name='MSSmartTagsPreventParsing'/>
  <meta content='blogger' name='generator'/>
  <link rel="alternate" type="application/atom+xml" title="OOXML is defective by design - Atom" href="http://ooxmlisdefectivebydesign.blogspot.com/feeds/posts/default" />
<link rel="alternate" type="application/rss+xml" title="OOXML is defective by design - RSS" href="http://ooxmlisdefectivebydesign.blogspot.com/feeds/posts/default?alt=rss" />
<link rel="service.post" type="application/atom+xml" title="OOXML is defective by design - Atom" href="http://www.blogger.com/feeds/283390674923940532/posts/default" />
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://www.blogger.com/rsd.g?blogID=283390674923940532" />
  

    <title>OOXML is defective by design</title>
    <style id='page-skin-1' type='text/css'><!--
/*
 * Blogger Template Style
 *
 * Simple II
 * by Jason Sutter
 */

/* Variable definitions
   ====================
   <Variable name="bgcolor" description="Page Background Color"
             type="color" default="#fff">

   <Variable name="textcolor" description="Text Color"
             type="color" default="#000">

   <Variable name="pagetitlecolor" description="Blog Title Color"
             type="color" default="#000">

   <Variable name="titlecolor" description="Post Title Color"
             type="color" default="#000">

   <Variable name="footercolor" description="Date and Footer Color"
             type="color" default="#555">

   <Variable name="linkcolor" description="Link Color"
             type="color" default="#58a">

   <Variable name="visitedlinkcolor" description="Visited Link Color"
             type="color" default="#999"> Used to be #969

   <Variable name="bordercolor" description="Border Color"
             type="color" default="#999">

   <Variable name="bodyfont" description="Text Font"
             type="font" default="normal normal 100% Georgia,Serif;">

   <Variable name="pagetitlefont" description="Blog Title Font"
             type="font"
             default="normal bold 200% Georgia,Serif">
*/

body {
  margin:0;
  font:normal normal 100% Georgia,Serif;;
  background:#ffffff;
  color:#000000;
}

a:link {
  color:#5588aa;
  text-decoration:none;
  }

a:visited {
  color:#999999;
  text-decoration:none;
  }

a:hover {
  color:#000000;
  text-decoration:underline;
}

a img {
  border-width:0;
}

#outer-wrapper {
  margin: 0px 3em 0 3em;
}

h1 {
  border-bottom:dotted 1px #999999;
  margin-bottom:0px;
  color: #000000;
  font: normal bold 200% Georgia,Serif;
}

h1 a, h1 a:link, h1 a:visited { 
  color: #000000;
}

h2 {
  margin:0px;
  padding: 0px;
}

#main .widget {
 padding-bottom:10px;
 margin-bottom:20px;
 border-bottom:dotted 1px #999999;
 clear: both;
}

#main .Header {
  border-bottom-width: 0px;
}

h2.date-header {
  padding-top:15px;
  color:#555555;
  padding-bottom:0px;
  margin-bottom:0px;
  font-size: 90%;
}

h3.post-title {
  font-size: 140%;
  color: #000000;
}

.post {
  padding-left:5%;
  padding-right:10%;
}

.post-footer {
  color:#555555;
}

#comments {
  padding-top:30px;
  color:#000000;
  padding-bottom:0px;
  margin-bottom:0px;
  font-weight:bold;
}

#comments .comment-footer {
  font-size:1em;
  font-weight:normal;
  color:#555555;
  margin-right:10px;
  display:inline;
}

.comment-author {
  margin-top: 3%;
}

.comment-body {
  font-size:1em;
  font-weight:normal;
}

.deleted-comment {
  font-style:italic;
  color:gray;
}
.comment-link {
  margin-left:.6em;
}

.feed-links {
  clear: both;
  line-height: 2.5em;
}

#blog-pager-newer-link {
  float: left;
 }

#blog-pager-older-link {
  float: right;
}
 
#blog-pager {   
  text-align: center; 
 }

.clear {
  clear: both;
}

.profile-img { 
  float: left;
  margin: 0 5px 5px 0;
}

body#layout #outer-wrapper {
  margin: 0px 50px 0 50px;
 }

--></style>
  <!-- --><style type="text/css">@import url('http://www.blogger.com/css/blog_controls.css');
@import url('http://www.blogger.com/dyn-css/authorization.css?blogID=283390674923940532');
#navbar-iframe { display:block }
</style>

<link rel='stylesheet' type='text/css' href='http://www.blogger.com/widgets/2791266615-blog.css'/><script type="text/javascript" src="http://www.blogger.com/widgets/2927639132-widgets.js"></script>
</head>

  <body>
  <div class='navbar section' id='navbar'><div class='widget Navbar' id='Navbar1'><iframe src="http://www.blogger.com/navbar.g?targetBlogID=283390674923940532&amp;blogName=OOXML+is+defective+by+design&amp;publishMode=PUBLISH_MODE_BLOGSPOT&amp;navbarType=BLUE&amp;layoutType=LAYOUTS&amp;homepageUrl=http%3A%2F%2Fooxmlisdefectivebydesign.blogspot.com%2F&amp;searchRoot=http%3A%2F%2Fooxmlisdefectivebydesign.blogspot.com%2Fsearch" marginwidth="0" marginheight="0" scrolling="no" frameborder="0" height="30px" width="100%" id="navbar-iframe"></iframe>
<div id="space-for-ie"></div></div></div>

  <div id='outer-wrapper'>
    <div class='main section' id='main'><div class='widget Header' id='Header1'>

  
    
    <div id='header-inner'>
      <div class='titlewrapper'>
        <h1 class='title'>
          
            OOXML is defective by design
          
        </h1>
      </div>
      <div class='descriptionwrapper'>
        <p class='description'><span></span></p>
      </div>
    </div>
  
</div><div class='widget Blog' id='Blog1'>
  
  <div class='blog-posts hfeed'>

    
  


    <!-- google_ad_section_start -->
    
      
        <h2 class='date-header'>Tuesday, August 28, 2007</h2>
      
      
  <div class='post hentry uncustomized-post-template'>
    <a name='7772935878076524105'></a>
    
      <h3 class='post-title entry-title'>
     
        
          <a href='http://ooxmlisdefectivebydesign.blogspot.com/2007/08/microsoft-office-xml-formats-defective.html'>Microsoft Office XML formats? Defective by design</a>
        
     
      </h3>
    

    <div class='post-header-line-1'></div>

    <div class='post-body entry-content'>
      <p><P>&nbsp;</P><br />  <P>Microsoft is trying to push new file formats that are using ZIP and XML. Are  those new file formats&nbsp;any good for Office developers ? In other words,&nbsp;should&nbsp;anyone feel safe to make direct access to file parts, and start getting free of running instances of Microsoft Office and its COM object model, usually through VBA ?</P><br />  <P>Microsoft does not run out of teasing. There is ton of videos, see <a href="http://channel9.msdn.com/ShowPost.aspx?PostID=73329">here</a>, and <a href="http://channel9.msdn.com/Showpost.aspx?postid=313246">here</a> for example, screencasts, articles and blog posts (self-serving Microsoft blog posts mostly) about how much they are opening up. It boils down to the following, excerpt from Microsoft Office 12 introduction <a href="http://blogs.msdn.com/brian_jones/archive/2005/06/01/424085.aspx"> white paper</a> &nbsp;:<br />  </P><br />  <P  style="background-color:#EEEEEE"><SPAN><EM>(...) <br />     The use of XML offers the benefits of greater <STRONG>transparency and openness</STRONG> than were possible with the previous binary file formats. The new formats allow Office documents to easily integrate with existing and future line-of-business systems, as the contents are now open and accessible. The new formats are also <br />designed with long-term robustness and accessibility in mind. (...) </EM><SPAN>     <EM>The binary file formats in use currently were designed in 1994&#8212;before the advent of XML and before widespread exchange of documents and data that is common today. These file formats, .doc, .xls, and .ppt, were introduced with the release of Microsoft Office 97, at a time when it was important to optimize the files for storage on slow hard drives and &#8220;floppy&#8221; disks; it was not as crucial to <STRONG>focus on easy access to data within the files for better content <br />reuse, document generation, and seamless integration of the documents into business processes</STRONG>. (...) </EM><SPAN><EM>The new XML-based file formats in these programs enable broader integration and interoperability between Office documents and enterprise applications. <br />Additionally, &#8220;Office 12&#8221; files are all wrapped using ZIP technologies, which allows for easy access to the content parts as well as standard compression, reducing file sizes and improving reliability and data recovery. (...) <SPAN>Because documents stored in the Open XML Formats are machine-readable and editable by any text editor or XML processor, <STRONG>solutions need not use <br />Microsoft Office programs to view or edit content within the documents.</STRONG> Enterprise business solutions can access document contents easily and efficiently. Technology providers can utilize the Microsoft Office System and Office authoring applications within their solutions, reuse Microsoft Office documents as other Office documents, or open and <STRONG>act on Office documents on other platforms and in other applications</STRONG>.</SPAN></EM></P><br />  <P>&nbsp;<br />  </P><br />  <P>They insist on the fact that, provided you make a valid use of the XML, pretty much changing the content of anything in an existing document can be achieved by sequentially 1) unzipping the content 2) making appropriate changes to one or more XML parts that are compatible with the provided XML schemas and open packaging relationships&nbsp;3) zipping the content back&nbsp;.</P><br />  <P>Let's see if that's true.</P><br />  <P><FONT size="3">1)&nbsp;Self-exploding spreadsheets</FONT></P><br />  <P><FONT size="3">2) Entered versus stored values</FONT></P><br />  <P><FONT size="3">3) Optimization artefacts become a feature instead of an embarrasment</FONT></P><br />  <P><FONT size="3">4) VML isn't XML</FONT></P><br />  <P><FONT size="3">5) Open packaging parts minefield</FONT></P><br />  <P><FONT size="3">6) International, but US English first and foremost</FONT></P><br />  <P><FONT size="3">7) Many ways to get in trouble</FONT></P><br />  <P><FONT size="3">8) Windows dates</FONT></P><br />  <P><FONT size="3">9) All roads lead to Office 2007</FONT></P><br />  <P><FONT size="3">10) A world of ZIP+OLE files</FONT></P><br />  <P><FONT size="3">11) Document security is a (bad) joke</FONT></P><br />  <P><FONT size="3">12) BIFF is gone...not!</FONT></P><br />  <P><FONT size="3">13) Document backwards compatibility subject to neutrino radio-activity</FONT></P><br />  <P><FONT size="3">14) ECMA 376 documents just do not exist</FONT></P><br />  <P><FONT size="3">15) How the ISO OpenDocument format (ODF) compares?</FONT></P><br />  <P><FONT size="3"></FONT></SPAN>&nbsp;</P><br />  </SPAN></SPAN><br />  <H2>1)&nbsp;Self-exploding spreadsheets</H2><br />  <P>To reproduce the scenario :</P><br />  <UL><LI>start Excel 2007 and create a new spreadsheet<LI>insert a value 10 in a cell<LI>insert a value 20 next to it<LI>select the two cells and click on the "sum" button to   create a sum of the two cells<LI>save the spreadsheet (xlsx file)<LI>close it and unzip it</UL><br />  <P>The relevant XML in the corresponding part xl/worksheets/sheet1.xml is :</P><br />  <pre>&lt;row r="2" spans="3:5"&gt;<br />&nbsp;&lt;c r="C2"&gt;<br />&nbsp;&nbsp;&lt;v&gt;10&lt;/v&gt;<br />&nbsp;&lt;/c&gt;<br />&nbsp;&lt;c r="D2"&gt;<br />&nbsp;&nbsp;&lt;v&gt;20&lt;/v&gt;<br />&nbsp;&lt;/c&gt;<br />&nbsp;&lt;c r="E2"&gt;<br />&nbsp;&nbsp;&lt;f&gt;SUM(C2:D2)&lt;/f&gt;<br />&nbsp;&nbsp;&lt;v&gt;30&lt;/v&gt;<br />&nbsp;&lt;/c&gt;<br />&lt;/row&gt;</pre><br />  <P>Pretty simple XML. Now say we want to edit cell E2 and set a constant value of <br />40&nbsp;in place&nbsp;of a formula. But instead of doing that with Excel 2007 interactively, we are going to do it manually :</P><br />  <UL><LI>unzip the file<LI>grab a zip part known as xl/worksheets/sheet1.xml<LI>make the edit described below<LI>put the updated zip part back in the zip package</UL><br />  <P>The corresponding valid (and carefully changed) XML for setting the constant <br />   value of 40 in cell E2 is :</P><br />  <pre>&lt;row r="2" spans="3:5"&gt;<br />&nbsp;&lt;c r="C2"&gt;<br />&nbsp;&nbsp;&lt;v&gt;10&lt;/v&gt;<br />&nbsp;&lt;/c&gt;<br />&nbsp;&lt;c r="D2"&gt;<br />&nbsp;&nbsp;&lt;v&gt;20&lt;/v&gt;<br />&nbsp;&lt;/c&gt;<br />&nbsp;&lt;c r="E2"&gt;<br />&nbsp;&nbsp;&lt;v&gt;40&lt;/v&gt;<br />&nbsp;&lt;/c&gt;<br />&lt;/row&gt;</pre><br />  <P>Now open the file in Excel 2007. You get a blocking error message which says :</P><br />  <P><IMG src="http://www.codeproject.com/useritems/ooxml_is_defective/DefectiveByDesign1.gif">&nbsp;<BR><br />   <EM>Excel 2007 cannot open the file we have manually updated</EM></P><br />  <P>Followed by another even more frightening message :</P><br />  <P><IMG src="http://www.codeproject.com/useritems/ooxml_is_defective/DefectiveByDesign2.gif"><br />   <BR><br />   <EM>According to Excel 2007, the problem is that the calculation chain is now corrupt</EM></P><br />  <P>Interestingly enough, we thought parts of a spreadsheet file were updatable as long as we did not touch elements that are, according to the ECMA 376 documentation (the official <a href="http://www.ecma-international.org/publications/standards/Ecma-376.htm">paper</a> from Microsoft), indexes to other parts.<br />  </P><br />  <P>Now that's an interesting issue. The ECMA 376 documentation says that the <br />calculation chain is the graph of formulas, sorted wrt to their dependencies. Suddenly, the little change we would like to make looks way more expensive. Rebuilding the graph of formulas ourselves is what Excel itself does, and sure enough it involves&nbsp;parsing the entire spreadsheet, discovering formulas, and applying formula parsing algorithms to induce a graph of the dependencies. It certainly sounds like we are going to have to rewrite a portion of Excel itself. Not every employer can afford waiting that much...Or perhaps that's Microsoft's way to tell us : <i>you shall not touch this without our approbation</i>.</P><br />  <P>We can perhaps get rid of the calculation chain, if we carefully delete the part and associated relationship. But then, there are three problems :</P><br />  <P>- Parts are intertwined together through implicit and explicit relationships <br />(relationships are separate zip entries). It gets even more grainy, and the risk of corruption increases. Again, we have to further take into account a number of details that are out of our scope, like how the calculation chain is defined as per the workbook part.</P><br />  <P>- If I were a programmer, the question would be : Microsoft gives no library <br />that I can use, at least not a library that I could use no matter&nbsp;the execution environment. Microsoft provides an API which works in a recent .NET run-time, and installs on Windows XP SP2 and Windows Vista. There goes the platform independence.</P><br />  <P>- If I delete the calculation chain, I am admitting that the resulting spreadsheet is being degraded, something that Excel 2007 does not suffer from since it takes care of that thanks to its infrastructure. In other words, making changes outside of Excel 2007 doesn't look as first-class citizen and safe and robust as it sounded first, and in either case either the application takes care of a lot of details, replicating what Excel itself does (there is no known non-Microsoft Excel 2007 implementation available out there), or Excel 2007 will have to do that for me next time the spreadsheet is opened. If the changes are made on a server without Excel 2007 installed and the resulting spreadsheet is distributed to employees throughout the organization, then every single employee will have to get through a full spreadsheet recalculation (arbitrarily lengthy) next time they open the spreadsheet. The application is a second-class citizen compared to Excel 2007, that's what everybody thinks : me and the employees.</P><br />  <P>What this shows pretty clearly is that either we lack the tools, or Microsoft <br />does not think we should be doing that in the first place. With that being said, if making a simple change to a cell is too much to ask, then what is this new format good for? The prospect of getting our recipients facing those dreaded message boxes is not exactly a change compared to the well known ugly stories with corrupted binary file formats.</P><br />  <p>Let's play the devil's advocate now and see how far it will take us. Here is the contents of the calculation chain, xl/calcChain.xml :</p><br /><pre><br />&lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?&gt;<br />&lt;calcChain xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main"&gt;<br />&nbsp;&lt;c r="E2" i="1"/&gt;<br />&lt;/calcChain&gt;<br /></pre><br /><p>The reference to formula in cell E2 is what seems to be causing the problem. All right, then since it's just XML, let's remove that reference. Edit the calculation chain xl/calcChain.xml so it looks like this :</p><br /><pre><br />&lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?&gt;<br />&lt;calcChain xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main"&gt;<br />&lt;/calcChain&gt;<br /></pre><br /><p>After the modification, if we open the file in Excel 2007, it still complains :</p><br />  <P><IMG src="http://www.codeproject.com/useritems/ooxml_is_defective/DefectiveByDesign6.gif">&nbsp;<BR><br />   <EM>Excel 2007 cannot open the file even if the calculation chain is cleaned up manually</EM></P><br /><p>I particularly like the wording : <i>catastrophic failure</i>. Now it looks like a lot of blood is spilling. Well, then let's stop the hemorrhage, and remove the contents of this part altogether. Make the update, and open the file in Excel 2007, it continues to complain :</p><br />  <P><IMG src="http://www.codeproject.com/useritems/ooxml_is_defective/DefectiveByDesign7.gif">&nbsp;<BR><br />  <EM>Excel 2007 cannot open the file even if the calculation chain is made empty</EM></P><br /><p>I guess it's time to take a look at the ECMA 376 documentation. In Part 4, page 2087, it says (emphasis mine) : </p><br /><pre  style="background-color:#EEEEEE"><br />3.6.2 calcChain (Calculation Chain Info)<br />This element represents the root of the calculation chain.<br /><br />&lt;complexType name="CT_CalcChain"&gt;<br />&nbsp;&lt;sequence&gt;<br />&nbsp;&nbsp;&lt;element name="c" type="CT_CalcCell" <b>minOccurs="1"</b> maxOccurs="unbounded"/&gt;<br />&nbsp;&nbsp;&lt;element name="extLst" minOccurs="0" type="CT_ExtensionList"/&gt;<br />&nbsp;&lt;/sequence&gt;<br />&lt;/complexType&gt;<br /></pre><br /><p>I guess there we have it, we can't have a calculation chain part with no cell reference in it. Excel guts spilling through the specs here, aren't it? Wait a minute, is this supposed to make into an international standard?</p><br />   <p>Let's do a quick summary : we had Excel 2007 complain that the calculation chain was left with a reference to a formula that did not exist anymore, but in fact Excel 2007 complains even with this manually fixed. The solution is to delete the physical calculation chain part and the relationship it has with the workbook (defined in the workbook relationship part xl/_rels/workbook.rels), and to update some other parts as well.</p><br /><br /><p>Let's get a visual diff of what it takes to make a "proper" change in a cell :</p><br /><br /><TABLE BORDER=0 CELLSPACING=1 BGCOLOR=#AAAAAA><TR><TD><TABLE BORDER=0 BGCOLOR=white CELLPADDING=1 CELLSPACING=1><TR><TD WIDTH=350><FONT FACE="Verdana"><B>BookSample.xlsx (original)</B></FONT></TD><TD WIDTH=60 ALIGN=CENTER><FONT FACE="Verdana"><B>DIFF</B></FONT></TD><TD WIDTH=350><FONT FACE="Verdana"><B>BookSample.xlsx (updated)</B></FONT></TD></TR><TR CLASS="diff"><TD CLASS="bot" BGCOLOR="#FFD71D"><a href="http://www.arstdesign.com/articles/workdir/[Content_Types].xml.html">[Content_Types].xml</a></TD><TD ALIGN=CENTER BGCOLOR="#FFD71D">1</TD><TD CLASS="bot" BGCOLOR="#FFD71D"><a href="http://www.arstdesign.com/articles/workdir/[Content_Types].xml.html">[Content_Types].xml</a></TD></TR><TR CLASS="std"><TD CLASS="bot" BGCOLOR="#FFFFFF"><a href="http://www.arstdesign.com/articles/workdir/_rels..rels.html">_rels/.rels</a></TD><TD ALIGN=CENTER BGCOLOR="#FFFFFF"></TD><TD CLASS="bot" BGCOLOR="#FFFFFF"><a href="http://www.arstdesign.com/articles/workdir/_rels..rels.html">_rels/.rels</a></TD></TR><TR CLASS="std"><TD CLASS="bot" BGCOLOR="#FFFFFF">&nbsp;&nbsp;&nbsp;<a href="http://www.arstdesign.com/articles/workdir/docProps.app.xml.html">docProps/app.xml</a></TD><TD ALIGN=CENTER BGCOLOR="#FFFFFF"></TD><TD CLASS="bot" BGCOLOR="#FFFFFF">&nbsp;&nbsp;&nbsp;<a href="http://www.arstdesign.com/articles/workdir/docProps.app.xml.html">docProps/app.xml</a></TD></TR><TR CLASS="std"><TD CLASS="bot" BGCOLOR="#FFFFFF">&nbsp;&nbsp;&nbsp;<a href="http://www.arstdesign.com/articles/workdir/docProps.core.xml.html">docProps/core.xml</a></TD><TD ALIGN=CENTER BGCOLOR="#FFFFFF"></TD><TD CLASS="bot" BGCOLOR="#FFFFFF">&nbsp;&nbsp;&nbsp;<a href="http://www.arstdesign.com/articles/workdir/docProps.core.xml.html">docProps/core.xml</a></TD></TR><TR CLASS="std"><TD CLASS="bot" BGCOLOR="#FFFFFF">&nbsp;&nbsp;&nbsp;<a href="http://www.arstdesign.com/articles/workdir/xl.workbook.xml.html">xl/workbook.xml</a></TD><TD ALIGN=CENTER BGCOLOR="#FFFFFF"></TD><TD CLASS="bot" BGCOLOR="#FFFFFF">&nbsp;&nbsp;&nbsp;<a href="http://www.arstdesign.com/articles/workdir/xl.workbook.xml.html">xl/workbook.xml</a></TD></TR><TR CLASS="diff"><TD CLASS="bot" BGCOLOR="#FFD71D">&nbsp;&nbsp;&nbsp;<a href="http://www.arstdesign.com/articles/workdir/xl._rels.workbook.xml.rels.html">xl/_rels/workbook.xml.rels</a></TD><TD ALIGN=CENTER BGCOLOR="#FFD71D">1</TD><TD CLASS="bot" BGCOLOR="#FFD71D">&nbsp;&nbsp;&nbsp;<a href="http://www.arstdesign.com/articles/workdir/xl._rels.workbook.xml.rels.html">xl/_rels/workbook.xml.rels</a></TD></TR><TR CLASS="std"><TD CLASS="bot" BGCOLOR="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="http://www.arstdesign.com/articles/workdir/xl.styles.xml.html">xl/styles.xml</a></TD><TD ALIGN=CENTER BGCOLOR="#FFFFFF"></TD><TD CLASS="bot" BGCOLOR="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="http://www.arstdesign.com/articles/workdir/xl.styles.xml.html">xl/styles.xml</a></TD></TR><TR CLASS="std"><TD CLASS="bot" BGCOLOR="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="http://www.arstdesign.com/articles/workdir/xl.theme.theme1.xml.html">xl/theme/theme1.xml</a></TD><TD ALIGN=CENTER BGCOLOR="#FFFFFF"></TD><TD CLASS="bot" BGCOLOR="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="http://www.arstdesign.com/articles/workdir/xl.theme.theme1.xml.html">xl/theme/theme1.xml</a></TD></TR><TR CLASS="diff"><TD CLASS="bot" BGCOLOR="#FFD71D">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="http://www.arstdesign.com/articles/workdir/xl.worksheets.sheet1.xml.html">xl/worksheets/sheet1.xml</a></TD><TD ALIGN=CENTER BGCOLOR="#FFD71D">2</TD><TD CLASS="bot" BGCOLOR="#FFD71D">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="http://www.arstdesign.com/articles/workdir/xl.worksheets.sheet1.xml.html">xl/worksheets/sheet1.xml</a></TD></TR><TR CLASS="diff"><TD CLASS="bot" BGCOLOR="#E0686E">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="http://www.arstdesign.com/articles/workdir/xl.calcChain.xml.html">xl/calcChain.xml</a></TD><TD ALIGN=CENTER BGCOLOR="#E0686E">4</TD><TD CLASS="bot" BGCOLOR="#FFFFFF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="http://www.arstdesign.com/articles/workdir/xl.calcChain.xml.html"></a></TD></TR></TABLE></TD></TR></TABLE><i>Original versus updated file : 40% of parts need a change!</i> (note : click the links to get the actual changes)<br /><br /><br /><ul><li>all we wanted to do was to make a change in a cell and we end up butchering the package.<li>remember, we don't want to have to deal with formulas or anything even further far away from our concern, we have no notion of formulas nor should have, the idea is to change a value in a cell. If the file format was properly designed, all it would take is an in-place replacement of the cell contents.<li>with VBA, to make a change in a cell, we do : <code>Range("E2").Value = 40</code>. Period. End of story.<li>40% of parts have to change in order to take into account our minor change. That certainly looks like having to care of the format's own dirty laundry, this is not acceptable by any stretch of the imagination for a modern format reportedly (Microsoft source) aimed to improve interoperability across platforms and applications. This is unfortunately exactly the situation in which we are with binary formats, something the new formats were supposed to fix!<br /><li>deleting a physical part is not a minor operation. Most ZIP libraries can't delete a physical part without uncompressing everything in a temp folder and rebuilding the package (thereby simulating a delete function). If your spreadsheet is big, this will take some time and space.<li>a full recalculation in the case there were formulas elsewhere.<li>can you imagine making more complex changes like replacing a pivot table with another ? Pivot tables have many (like hundreds) ties with everything in the spreadsheet.</ul><br />  <P>&nbsp;</P><br />  <H2>2) Entered versus stored values</H2><br />  <P>We all take for granted that when we type a value such as <br />   1234.1234 in a cell of a spreadsheet, that's what actually gets stored. Excel has this auto-number format matching capability where it tries to make sense of what is manually entered in order to deduce if that's a string, a number, a boolean or a date and applies a number format accordingly, but what's being stored as a value is what is entered. By the way, if you hit Alt+F11 in Excel, and enter something like Range("C3").Value and run the macro, you'll get the entered value in cell C3&nbsp;; if you enter something like Range("C3").Text, you'll get the formatted value in cell C3, where the number format has been applied to the value. Note that the return value takes advantage of the locale and number formatting which means you may get "1234,1234" (note the comma) instead of "1234.1234".</P><br />  <P>Is this storage neutrality true with the new formats?</P><br />  <P>To reproduce the scenario :</P><br />  <UL><LI>start Excel 2007 and create a new spreadsheet<LI>type value 123456.123456<br />   <LI>resize the column manually so that the value entirely shows<br />   <LI>hit return and type 12345.12345<br />   <LI>hit return and type 1234.1234<br />   <LI>hit return and type 123.123<br />   <LI>hit return and type 12.12<br />   <LI>save the spreadsheet (xlsx file)<br />   <LI>close it, unzip it</LI><br />  </UL><br />  <p>Here is a screenshot of what you should see at this point :</p><br />  <IMG src="http://www.codeproject.com/useritems/ooxml_is_defective/DefectiveByDesign3.gif"><br><br />  <i>Typing a few numeric values in Excel 2007</i><br><br />  <P>The corresponding XML in the main part <br />   xl/worksheets/sheet1.xml is :</P><br />  <pre>&lt;sheetData&gt;<br />&nbsp;&lt;row r="2" spans="4:4"&gt;<br />&nbsp;&nbsp;&lt;c r="D2"&gt;<br />&nbsp;&nbsp;&nbsp;&lt;v&gt;123456.123456&lt;/v&gt;<br />&nbsp;&nbsp;&lt;/c&gt;<br />&nbsp;&lt;/row&gt;<br />&nbsp;&lt;row r="3" spans="4:4"&gt;<br />&nbsp;&nbsp;&lt;c r="D3"&gt;<br />&nbsp;&nbsp;&nbsp;&lt;v&gt;12345.123449999999&lt;/v&gt;<br />&nbsp;&nbsp;&lt;/c&gt;<br />&nbsp;&lt;/row&gt;<br />&nbsp;&lt;row r="4" spans="4:4"&gt;<br />&nbsp;&nbsp;&lt;c r="D4"&gt;<br />&nbsp;&nbsp;&nbsp;&lt;v&gt;1234.1233999999999&lt;/v&gt;<br />&nbsp;&nbsp;&lt;/c&gt;<br />&nbsp;&lt;/row&gt;<br />&nbsp;&lt;row r="5" spans="4:4"&gt;<br />&nbsp;&nbsp;&lt;c r="D5"&gt;<br />&nbsp;&nbsp;&nbsp;&lt;v&gt;123.123&lt;/v&gt;<br />&nbsp;&nbsp;&lt;/c&gt;<br />&nbsp;&lt;/row&gt;<br />&nbsp;&lt;row r="6" spans="4:4"&gt;<br />&nbsp;&nbsp;&lt;c r="D6"&gt;<br />&nbsp;&nbsp;&nbsp;&lt;v&gt;12.12&lt;/v&gt;<br />&nbsp;&nbsp;&lt;/c&gt;<br />&nbsp;&lt;/row&gt;<br />&lt;/sheetData&gt; </pre><br />  <P>The problem is that Excel 2007 does not store what we entered. If we read the XML, we are going to grab numbers that have rounding errors compared to the actual numbers we typed. Let's see how far the problem goes :</P><TABLE id="Table1" cellSpacing="1" cellPadding="1" width="300" border="1"><TR><TD><STRONG>Entered value</STRONG></TD><TD><STRONG>Stored value</STRONG></TD><TD><STRONG>Rounding error</STRONG></TD></TR><TR><TD>123456.123456</TD><TD>123456.123456</TD><TD>0</TD></TR><TR><TD>12345.12345</TD><TD>12345.123449999999</TD><TD>o(1e-5)</TD></TR><br /><TR><TD>1234.1234</TD><TD>1234.1233999999999</TD><TD>o(1e-4)</TD></TR><TR><TD>123.123</TD><TD>123.123</TD><TD>0</TD></TR><TR><TD>12.12</TD><TD>12.12</TD><br /><TD>0</TD></TR></TABLE><P>Not only there is a rounding error, but its order of magnitude changes depending on the value. Ironically enough, if you entered 4321.4321, it would be stored as is, with no rounding error.</P><br />  <P>It is absolutely lost on me how implementers are expected to deal with this mess. The spreadsheet does not reflect the proper values, and you can easily see where it goes. Imagine non-Microsoft applications used in healthcare and critical systems relying on the spreadsheet data. Not only the rounding error seems arbitrary (one would have to go back and study the artefacts of IEEE floating-point values, several decades of work), but it changes. There is no way we can possibly take advantage of this, with one notable exception : if we are able to be in an execution environment for which reading those floating-point values does not produce those artefacts, and returns the proper entered values, then we are good. Problem : Microsoft does not document the execution environment. We can fairly assume its Windows, but what else? And if I am using Linux, how do I work with this?</P><br />  <P>It's important to understand that if we open the spreadsheet in Excel 2007, we see the proper values. No loss (based on the values entered) seem to have occured, the problem is that the data in XML just cannot be used as is.</P><br />  <P>As an aside, the stored value does not use the locale (it always uses the dot as decimal separator), therefore we have to assume this is all US English. If we wrote software in Excel VBA that grabs the value in cells, then processes it, there is no way we could migrate our VBA code to work with this XML part without substantial rework. We are left with Excel's own international implementation artefacts, undocumented.</P><br />  <P>&nbsp;</P><br />  <H2>3) Optimization artefacts become a feature instead of an embarrasment</H2><br />  <P>Historically, the BIFF file format used in Excel spreadsheets was designed to be small and fast. But this design decision goes all way back to early 90s, when the Pentium CPU did not exist yet. Regular desktop computers we use everyday are at least several orders of magnitude faster and memory-friendly that those early computers were. Yet, Microsoft chose to keep those optimization artefacts as is, with the side effect that they are now exposed to the surface as part of the XML.</P><br />  <P>Among interesting optimizations is Excel insistence in trying to factor formulas as much as possible. This happens with Excel when you create a formula, then drag the cell to replicate it in other cells. That's shared formulas. Excel chooses to declare the formula itself only once, and then creates a mechanism to infer the formula in other cells (the relative <br />position counts as an offset).</P><br />  <P>Shared formulas are supposed to be transparent for developers. Is it true?</P><br />  <P>To reproduce the scenario :</P><br />  <UL><LI>start Excel 2007 and create a new spreadsheet<br />   <LI>enter value 2 in cell C4<br />   <LI>click on cell C4, click on the bottom-right corner, and drag cell C4 down to C10 to replicate the content<LI>enter value 3 in cell D4<br />   <LI>click on cell D4, click on the bottom-right corner, and drag cell D4 down to D10 to replicate the content<br />   <LI>enter formula =C4-D4 in cell E4<br />   <LI>click on cell E4, click on the bottom-right corner, and drag cell E4 down to E10 to replicate the formula<br />   <LI>save the spreadsheet (xlsx file)<br />   <LI>close it, unzip it</UL><br />  <P>Here is a screenshot of what you should see at this point :</P><br />  <img src="http://www.codeproject.com/useritems/ooxml_is_defective/DefectiveByDesign4.gif"><br><br />  <i>Typing a few numbers and formulas in Excel 2007</i><br><br />  <P>The corresponding XML in the main part <br />   xl/worksheets/sheet1.xml is :</P><br />  <pre><br />&lt;sheetData&gt;<br />&nbsp;&lt;row r="4" spans="3:5"&gt;<br />&nbsp;&nbsp;&lt;c r="C4"&gt;<br />&nbsp;&nbsp;&nbsp;&lt;v&gt;2&lt;/v&gt;<br />&nbsp;&nbsp;&lt;/c&gt;<br />&nbsp;&nbsp;&lt;c r="D4"&gt;<br />&nbsp;&nbsp;&nbsp;&lt;v&gt;3&lt;/v&gt;<br />&nbsp;&nbsp;&lt;/c&gt;<br />&nbsp;&nbsp;&lt;c r="E4" s="1"&gt;<br />&nbsp;&nbsp;&nbsp;&lt;f&gt;C4-D4&lt;/f&gt;<br />&nbsp;&nbsp;&nbsp;&lt;v&gt;-1&lt;/v&gt;<br />&nbsp;&nbsp;&lt;/c&gt;<br />&nbsp;&lt;/row&gt;<br />&nbsp;&lt;row r="5" spans="3:5"&gt;<br />&nbsp;&nbsp;&lt;c r="C5"&gt;<br />&nbsp;&nbsp;&nbsp;&lt;v&gt;2&lt;/v&gt;<br />&nbsp;&nbsp;&lt;/c&gt;<br />&nbsp;&nbsp;&lt;c r="D5"&gt;<br />&nbsp;&nbsp;&nbsp;&lt;v&gt;3&lt;/v&gt;<br />&nbsp;&nbsp;&lt;/c&gt;<br />&nbsp;&nbsp;&lt;c r="E5" s="1"&gt;<br />&nbsp;&nbsp;&nbsp;&lt;f t="shared" ref="E5:E10" si="0"&gt;C5-D5&lt;/f&gt;<br />&nbsp;&nbsp;&nbsp;&lt;v&gt;-1&lt;/v&gt;<br />&nbsp;&nbsp;&lt;/c&gt;<br />&nbsp;&lt;/row&gt;<br />&nbsp;&lt;row r="6" spans="3:5"&gt;<br />&nbsp;&nbsp;&lt;c r="C6"&gt;<br />&nbsp;&nbsp;&nbsp;&lt;v&gt;2&lt;/v&gt;<br />&nbsp;&nbsp;&lt;/c&gt;<br />&nbsp;&nbsp;&lt;c r="D6"&gt;<br />&nbsp;&nbsp;&nbsp;&lt;v&gt;3&lt;/v&gt;<br />&nbsp;&nbsp;&lt;/c&gt;<br />&nbsp;&nbsp;&lt;c r="E6" s="1"&gt;<br />&nbsp;&nbsp;&nbsp;&lt;f t="shared" si="0"/&gt;<br />&nbsp;&nbsp;&nbsp;&lt;v&gt;-1&lt;/v&gt;<br />&nbsp;&nbsp;&lt;/c&gt;<br />&nbsp;&lt;/row&gt;<br />&nbsp;&lt;row r="7" spans="3:5"&gt;<br />&nbsp;&nbsp;&lt;c r="C7"&gt;<br />&nbsp;&nbsp;&nbsp;&lt;v&gt;2&lt;/v&gt;<br />&nbsp;&nbsp;&lt;/c&gt;<br />&nbsp;&nbsp;&lt;c r="D7"&gt;<br />&nbsp;&nbsp;&nbsp;&lt;v&gt;3&lt;/v&gt;<br />&nbsp;&nbsp;&lt;/c&gt;<br />&nbsp;&nbsp;&lt;c r="E7" s="1"&gt;<br />&nbsp;&nbsp;&nbsp;&lt;f t="shared" si="0"/&gt;<br />&nbsp;&nbsp;&lt;v&gt;-1&lt;/v&gt;<br />&nbsp;&nbsp;&lt;/c&gt;<br />&nbsp;&lt;/row&gt;<br />&nbsp;&lt;row r="8" spans="3:5"&gt;<br />&nbsp;&nbsp;&lt;c r="C8"&gt;<br />&nbsp;&nbsp;&nbsp;&lt;v&gt;2&lt;/v&gt;<br />&nbsp;&nbsp;&lt;/c&gt;<br />&nbsp;&nbsp;&lt;c r="D8"&gt;<br />&nbsp;&nbsp;&nbsp;&lt;v&gt;3&lt;/v&gt;<br />&nbsp;&nbsp;&lt;/c&gt;<br />&nbsp;&nbsp;&lt;c r="E8" s="1"&gt;<br />&nbsp;&nbsp;&nbsp;&lt;f t="shared" si="0"/&gt;<br />&nbsp;&nbsp;&nbsp;&lt;v&gt;-1&lt;/v&gt;<br />&nbsp;&nbsp;&lt;/c&gt;<br />&nbsp;&lt;/row&gt;<br />&nbsp;&lt;row r="9" spans="3:5"&gt;<br />&nbsp;&nbsp;&lt;c r="C9"&gt;<br />&nbsp;&nbsp;&nbsp;&lt;v&gt;2&lt;/v&gt;<br />&nbsp;&nbsp;&lt;/c&gt;<br />&nbsp;&nbsp;&lt;c r="D9"&gt;<br />&nbsp;&nbsp;&nbsp;&lt;v&gt;3&lt;/v&gt;<br />&nbsp;&nbsp;&lt;/c&gt;<br />&nbsp;&nbsp;&lt;c r="E9" s="1"&gt;<br />&nbsp;&nbsp;&nbsp;&lt;f t="shared" si="0"/&gt;<br />&nbsp;&nbsp;&nbsp;&lt;v&gt;-1&lt;/v&gt;<br />&nbsp;&nbsp;&lt;/c&gt;<br />&nbsp;&lt;/row&gt;<br />&nbsp;&lt;row r="10" spans="3:5"&gt;<br />&nbsp;&nbsp;&lt;c r="C10"&gt;<br />&nbsp;&nbsp;&nbsp;&lt;v&gt;2&lt;/v&gt;<br />&nbsp;&nbsp;&lt;/c&gt;<br />&nbsp;&nbsp;&lt;c r="D10"&gt;<br />&nbsp;&nbsp;&nbsp;&lt;v&gt;3&lt;/v&gt;<br />&nbsp;&nbsp;&lt;/c&gt;<br />&nbsp;&nbsp;&lt;c r="E10" s="1"&gt;<br />&nbsp;&nbsp;&nbsp;&lt;f t="shared" si="0"/&gt;<br />&nbsp;&nbsp;&nbsp;&lt;v&gt;-1&lt;/v&gt;<br />&nbsp;&nbsp;&lt;/c&gt;<br />&nbsp;&lt;/row&gt;<br />&lt;/sheetData&gt; <br /></pre><br />  <P>In cell E5, we see a "ref "attribute where the shared formula range applies, a "si" attribute which identifies the shared formula range (itself redundant with the "ref" attribute), and the actual formula for that cell. But in cell E6, the cell below E5 in the grid, we see a definition with just a "si" attribute. In other words, cell E6 is linked to cell E5.</P><br />  <P>Here is the problem, let's say we make a manual change to cell E5 and remove the formula. We've seen in the first section of this article that the calculation chain is left unsynched, but an additional problem is that cell E6 is also left unsynched because its "si" attribute now points to nowhere. Note that the situation isn't any better if we merely update the formula, by doing so cell E5 is fine, but linked cells will reference the new formula, not the old one. So a simple change in cell E5 actually spreads unintentionally. It goes without saying that it's very expensive to make a simple change.</P><br />  <P>That is a direct result of the optimization artefact. Someone willing to make a change cannot proceed without taking care of depending cells if the cell defines a shared formula range. The problem gets only bigger since we have to either remove the shared formula altogether in all cells, or translate the shared formula definition accordingly, which implies <br />parsing the formula (the goal was only make a change in a cell!) and making a number of offset changes, many of which are left for the user to discover (formula tokens are complex). To remove the shared formula, the actual formula definitions in linked cells have to be built, and that's where an algorithm has to find a way to create these, essentially rolling back Excel's optimization as a preliminary step.</P><br />  <P>We have a case where an optimization artefact becoming an embarassment, not a feature.</P><br />  <p>Let's see how the situation compares to the old Excel binary file format (BIFF internal format is stored inside an OLE container). Here are the corresponding BIFF records :</p><br />  <pre><br /><font color=green>// BIFF : a shared formula, and cells linked to the shared formula</font><br />[SHRFMLA 0015]  03 00 08 00 03 03 00 06 0B 00 4C 00 00 FE C0 4C 00 00 FF C0 04<br />[FORMULA 001B]  04 00 03 00 3E 00 00 00 00 00 00 00 00 40 08 00 05 00 03 FE 05 00 01 03 00 03 00<br />[FORMULA 001B]  05 00 03 00 3E 00 00 00 00 00 00 00 00 00 08 00 06 00 03 FF 05 00 01 03 00 03 00<br />[FORMULA 001B]  06 00 03 00 3E 00 00 00 00 00 00 00 F0 BF 08 00 07 00 03 FF 05 00 01 03 00 03 00<br />[FORMULA 001B]  07 00 03 00 0F 00 00 00 00 00 00 00 F0 3F 08 00 08 00 03 FF 05 00 01 03 00 03 00<br />[FORMULA 001B]  08 00 03 00 0F 00 00 00 00 00 00 00 00 C0 08 00 03 00 03 FF 05 00 01 03 00 03 00<br /><br /><font color=green>// BIFF : same than above, made understandable</font><br />[SHRFMLA 0015]  (ref = 03 00 08 00 03 03) (formula = [currentrow][currentcolumn-2]-[currentrow][currentcolumn-1])<br />[FORMULA 001B]  (cell row = 5 col = E) (formula is a link to the shared formula)<br />[FORMULA 001B]  (cell row = 6 col = E) (formula is a link to the shared formula)<br />[FORMULA 001B]  (cell row = 7 col = E) (formula is a link to the shared formula)<br />[FORMULA 001B]  (cell row = 8 col = E) (formula is a link to the shared formula)<br />[FORMULA 001B]  (cell row = 9 col = E) (formula is a link to the shared formula)<br />  </pre><br />  <p>With the Excel binary format, the design is right. The shared formula is defined outside a cell, so you can very simply remove the formula in cell E5 without breaking other cells. From a programming perspective, <b>the new XML format qualifies as a regression compared to the binary file format</b>.</p><br />  <P>&nbsp;</P><br />  <H2>4) VML isn't XML</H2><br />  <P>Contrary to what the&nbsp;ECMA 376 documentation says in many places, VML drawing parts are not deprecated at all. VML is in fact very pervasive in Word, Excel and Powerpoint documents, so it's even more a blatant problem.</P><br /><p>In the ECMA 376 documentation, part 4, page 4343, we learn : (emphasis mine)</p><br /><pre style="background-color:#EEEEEE"><br />[Note: The VML format is a legacy format originally introduced with Office 2000 <br />and is included and fully <b>defined in this Standard for backwards compatibility <br />reasons</b>. The DrawingML format is a newer and richer format created with the <br />goal of eventually replacing any uses of VML in the Office Open XML formats. VML <br />should be considered a deprecated format included in Office Open XML for legacy <br />reasons only and new applications that need a file format for drawings are strongly <br />encouraged to use preferentially DrawingML .end note]<br /></pre><br />  <P>Here is a way to create a VML part in a <b>new</b> document :</P><br />  <UL><LI>start Excel 2007 and create a new spreadsheet<br />   <LI>right-click and choose Insert Comment<br />   <LI>enter a comment<br />   <LI>save the spreadsheet (xlsx file)<br />   <LI>close it, unzip it</UL><br />  <P>The corresponding XML in the drawing part <br />   xl/drawings/vmlDrawing1.vml is :</P><br />  <pre><br />&lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?&gt;<br />&lt;xml xmlns:v="urn:schemas-microsoft-com:vml" <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;xmlns:o="urn:schemas-microsoft-com:office:office" <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;xmlns:x="urn:schemas-microsoft-com:office:excel"&gt;<br />&nbsp;&lt;o:shapelayout v:ext="edit"&gt;<br />&nbsp;&nbsp;&lt;o:idmap v:ext="edit" data="1"/&gt;<br />&nbsp;&lt;/o:shapelayout&gt;<br />&nbsp;&lt;v:shapetype id="_x0000_t202" coordsize="21600,21600" o:spt="202" path="m,l,21600r21600,l21600,xe"&gt;<br />&nbsp;&nbsp;&lt;v:stroke joinstyle="miter"/&gt;<br />&nbsp;&nbsp;&lt;v:path gradientshapeok="t" o:connecttype="rect"/&gt;<br />&nbsp;&lt;/v:shapetype&gt;<br />&nbsp;&lt;v:shape id="_x0000_s1025" type="#_x0000_t202" style="position:absolute;<br />margin-left:203.25pt;margin-top:37.5pt;width:96pt;height:55.5pt;z-index:1;<br />visibility:hidden" fillcolor="#ffffe1" o:insetmode="auto"&gt;<br />&nbsp;&nbsp;&lt;v:fill color2="#ffffe1"/&gt;<br />&nbsp;&nbsp;&lt;v:shadow on="t" color="black" obscured="t"/&gt;<br />&nbsp;&nbsp;&lt;v:path o:connecttype="none"/&gt;<br />&nbsp;&nbsp;&lt;v:textbox style="mso-direction-alt:auto"&gt;<br />&nbsp;&nbsp;&nbsp;&lt;div style="text-align:left"/&gt;<br />&nbsp;&nbsp;&lt;/v:textbox&gt;<br />&nbsp;&nbsp;&lt;x:ClientData ObjectType="Note"&gt;<br />&nbsp;&nbsp;&nbsp;&lt;x:MoveWithCells/&gt;<br />&nbsp;&nbsp;&nbsp;&lt;x:SizeWithCells/&gt;<br />&nbsp;&nbsp;&nbsp;&lt;x:Anchor&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;4, 15, 2, 10, 6, 15, 6, 4&lt;/x:Anchor&gt;<br />&nbsp;&nbsp;&nbsp;&lt;x:AutoFill&gt;False&lt;/x:AutoFill&gt;<br />&nbsp;&nbsp;&nbsp;&lt;x:Row&gt;3&lt;/x:Row&gt;<br />&nbsp;&nbsp;&nbsp;&lt;x:Column&gt;3&lt;/x:Column&gt;<br />&nbsp;&nbsp;&lt;/x:ClientData&gt;<br />&nbsp;&lt;/v:shape&gt;<br />&lt;/xml&gt;</pre><br />  <P>From a pure markup perspective, it is XML, but there are application-encoded values such as <code>="m,l,21600r21600,l21600,xe"</code> and <code>4, 15, 2, 10, 6, 15, 6, 4</code> which contradict proper XML design, ie in a way that it is both poor XML, and cannot be used by XSLT transforms. VML allows far more complicated values in the general case, including conditionals expressed in their own language.</p><br /><pre style="background-color:#EEEEEE"><br />&lt;v:shape style='top: 0; left: 0; width: 250; height: 250'<br />       stroke="true" strokecolor="red" strokeweight="2" fill="true"<br />       fillcolor="green" coordorigin="0 0" coordsize="175 175"&gt;<br />&lt;v:path v="m 8,65<br />  l 72,65,92,11,112,65,174,65,122,100,142,155,92,121,42,155,60,100<br />  x e"/&gt;<br />&lt;formulas&gt;<br />  &lt;f eqn="sum #0 0 10800"/&gt;<br />  &lt;f eqn="prod #0 2 1"/&gt;<br />  &lt;f eqn="sum 21600 0 @1"/&gt;<br />  &lt;f eqn="sum 0 0 @2"/&gt;<br />  &lt;f eqn="sum 21600 0 @3"/&gt;<br />  &lt;f eqn="if @0 @3 0"/&gt;<br />  &lt;f eqn="if @0 21600 @1"/&gt;<br />  &lt;f eqn="if @0 0 @2"/&gt;<br />  &lt;f eqn="if @0 @4 21600"/&gt;<br />  &lt;f eqn="mid @5 @6"/&gt;<br />  &lt;f eqn="mid @8 @5"/&gt;<br />  &lt;f eqn="mid @7 @8"/&gt;<br />  &lt;f eqn="mid @6 @7"/&gt;<br />  &lt;f eqn="sum @6 0 @5"/&gt;<br />&lt;/formulas&gt;<br />&lt;/v:shape&gt;<br /></pre><br /><p>If that is XML, then I propose writing C code the following way :</p>  <br /><pre style="background-color:#EEEEEE"><br />&lt;v:shape style='top: 0; left: 0; width: 250; height: 250'<br />       stroke="true" strokecolor="red" strokeweight="2" fill="true"<br />       fillcolor="green" coordorigin="0 0" coordsize="175 175"&gt;<br />&lt;v:path v="m 8,65<br />  l 72,65,92,11,112,65,174,65,122,100,142,155,92,121,42,155,60,100<br />  x e"/&gt;<br />&lt;formulas&gt;<br />  &lt;f eqn="<br />int main(int argc, char** argv)<br />{<br />  printf("Hello World\n");<br />  return 0;<br />}<br />  "/&gt;<br />&lt;/formulas&gt;<br />&lt;/v:shape&gt;<br /></pre><br /><p>This is XML, right? There are angle brackets, it conforms to the XML W3C recommendation, therefore it's XML.</p><br /><p>VML also contains <b>application-specific</b> markup, with no documentation associated to it, for instance in the example above, <code>4, 15, 2, 10, 6, 15, 6, 4</code>. Because only Microsoft used this markup, there was no need to define it in its own namespace and so on. But now that VML is part of ECMA 376, either ISO accepts a vendor-specific markup, which defies the point of ISO standards in the first place, or it just contradicts ISO standards.</p><br />  <P>The implication for an implementer, or for someone willing to make a change is that there is no way someone can possibly edit this thing without a proper implementation of the VML library itself. The risk of corruption is extremely high. Obviously, Microsoft expects that VML parts are replaced by other VML parts as a whole, without a finer granularity. The problem is that VML too can contain references to objects and other parts, so that contradicts even a simple <EM>template</EM> scenario.</P><br />  <P>VML is an old, undocumented, library that speaks volume of past Microsoft lock-in strategy. Mr Bill Gates in person sent in 1998 a <a href="http://antitrust.slated.org/www.iowaconsumercase.org/011607/2000/PX02991.pdf">memo</a> to the Office product group (led by Steven Sinofsky at the time), memo undisclosed to the public thanks to the IOWA consumer case :</P><br />  <P><TABLE id="Table2" cellSpacing="1" cellPadding="1" border="1"><br /><TR><TD valign="top" style="background-color:#EEEEEE"><br />      <P>From: Bill Gates<BR><br />       Sent: Saturday, December 5 1998<BR><br />       To: Bob Muglia, Jon DeVann, Steven Sinofsky<BR><br />       Subject : Office rendering</P><br />      <P><EM>One thing we have got to change in our strategy - allowing Office documents to be rendered very well by other peoples browsers is one of <br />the most destructive things we could do to the company.</EM></P><br />      <P><EM>We have to stop putting any effort into this and make sure that Office documents very well depends on PROPRIETARY IE capabilities.</EM></P><br />      <P><EM>Anything else is suicide for our platform. This is a case where Office has to avoid doing something to destroy Windows.</EM></P><br />      <P><EM>I would be glad to explain at a greater length.</EM></P><br />      <P><EM>Likewise this love of DAV in Office/Exchange is a huge problem. I would also like to make sure people understand this as well.</EM></P><br />     </TD><br />    </TR><br />   </TABLE><br />  </P><br />  <P>The undocumented VML library shipped in Internet Explorer 5 in 2000, and has been part of Internet Explorer ever since. The DAV protocol (Distributed Authoring and Versioning) is an international cross-platform standard, open to everybody. God only knows why Bill Gates likes so much VML, and dislikes so much DAV...</P><br />  <P>For the record, the ECMA 376 documentation describes the VML markup, but it does not specify it. Much of application-defined behaviors are left for one to guess.</P><br />  <P>&nbsp;</P><br />  <H2>5) Open packaging parts minefield</H2><br />  <P>The underlying architecture of how zip entries relate together is called by Microsoft&nbsp;"open packaging conventions". What it means is that zip entries are not independent, or even related by way of a single master zip entry which would work as a directory of all zip entries of relevance. There is a logical tree of entries which uses separate zip entries to define relations between zip entries. The logical tree has nothing to do with the physical tree of zip entries in a package, despite Microsoft continuously using screenshots of Windows XP's built-in ZIP folders to mimic a folder hierarchy.</P><br />  <P>The problem with such an architecture is that a part may or may not relate to another and there is no standard way to know. Often, there is a <STRONG>r:id</STRONG> attribute right in the content of some XML part that tells the application that there is a relation, but this is not standard. By the way, Microsoft's PDF fixed format competitor called XPS is also based on the same underlying architecture, except that the team who developed XPS did not quite want to play by the same rules than the Office team. For instance the XPS main zip document entry related to one or more XPS pages with an attribute such as : <STRONG>Source="Pages/1.fpage"</STRONG>. In other words, they are not using the <STRONG>r:id</STRONG> attribute, instead relying on their own mechanism. This makes it impossible for a generic library to know which part relates to which part, and it has an unfortunate consequence.</P><br />  <P>The unfortunate consequence is being unable to know whether a part relates or not to another part makes it impossible to know, when you delete a part, if you are going to corrupt the document or not. The document becomes corrupt if it points or relates (implicitely or explicitely) to a missing part. It's unclear why Microsoft chose this way of doing things, obviously leading to an internal chaos, instead of just copying the research from the OpenOffice project, where a central directory is used (OpenOffice ZIP initiative predates Microsoft's by at least three years, despite Microsoft stealing the thunder).</P><br />  <P>When you don't know the dependencies of a part, the consequence is obvious, you leave those parts alone. If you do this enough times, it clutters up the package, and soon enough you end up with a package containing any number of parts god only knows why they are there. Add to this you can add a part of any content type (arbitrary MIME type), and you have a recipe for disaster. Among other things, virus could proliferate.</P><br />  <P>Microsoft's deletePart() function which is available in their System.IO.Packaging library (itself part of .NET), does not solve this problem. We have a case of poor engineering, creating unnecessary problems for others to worry about.</P><br />  <P>&nbsp;</P><br />  <H2>6) International, but US English first and foremost</H2><br />  <P>An important ongoing tension with Office documents is the support for locales. Microsoft historically used a number of mechanisms to address this need, but they kept evolving and Microsoft aggregated all mechanisms to keep compatibility with older versions. What was hidden is being surfaced with the new XML. Anything that gets displayed, calculated, rendered or stored depends one way or another on an complex and undocumented combination of locale settings including : the Office application language, the Office application language settings (per application), the Office&nbsp;document language settings (per document), the system locale of the operating system.</P><br />  <P>To save them time, Microsoft chose to store XML using the US English locale regardless of all settings above.</P><br />  <P>This has an unfortunate consequence for implementers or those willing to make a manual change. Indeed, Microsoft is imposing everybody else to adapt to US English locale options (separators, date formats, formula conventions, ...) despite the fact that when using Office interactively, this fact is hidden to the user. The Office application infrastructure manages  to abstract it away from users, which is a good thing. <b>Office developers using VBA all over the world are used to work with localized functions, the complexity is hidden to them</b>. But since the XML resurfaces this US English locale, all the complexity is left for one to implement. We are talking two decade worth of internationalization issues, for Office-related locale issues and Windows-related locale issues. To get an idea of how bad the situation is, suffice to say that a Microsoft employee part of the internationalization team in Windows has a <a href="http://blogs.msdn.com/michkap/default.aspx">blog</a> where he posts daily horror stories.</P><br />  <P>Also, for Excel formulas, it means the formula names are US English formula names, which you'll never see in Excel if you are using a locale version such as French or Brazilian. It's left for one to guess how to map function names one way to another, and of course the ECMA 376 documentation does not provide those localized formula names. If you intend not to implement a mapping to a locale, ideally your customer's locale, it implies you are willing to work with US English function names (plus US English separators, ...). <B>If your company has invested in libraries or developed libraries in-house, they cannot be used anymore.</B></P><br />  <P>Can it get any worse than that?</P><br />  <P>Unfortunately yes.</P><br />  <P>Despite Microsoft insistence to store everything using the US English locale, they still manage to store a number of contradicting country/encoding flags in the XML. Examples of that are DrawingML and VML languages. They store encoding tags for storing text chunks, but text chunks in document itself does not use any such encoding tag. It is in fact entirely possible that DrawingML and VML are implementations which involve nothing localized itself but which store localized tags in the document, while the rest of languages (WordML, SpreadsheetML, ...) are implemented otherwise : their implementation is chockful of encoding settings, but they need not store anything in the document itself. In other words, everything gets localized at run-time with WordML, SpreadsheetML, ... except DrawingML and VML.</P><br /><P>It's clear at this point that the legacy shows...One would have expected Microsoft to fix this once for all, provide a consistent framework. They chose not do so, and as a result, it's left for any implementer or someone willing to make a change to do the heavy lifting. What we are talking about here is entire internationalization implementation stacks which can represent years of work and stabilization. Ironically enough, you will not only have to implement this stuff (reverse engineering since it is not addressed by the ECMA 376 documentation), you will have to implement in a way that reproduces current Office flaws. No matter how correct your implementation is, you have to retrofit it to work just like Office does.</P><br /><p>To get a flavor of non-US English within US-English (thereby violating ECMA 376's own rules), all you have to do is to insert a chart :</p><br /><ul><li>start Excel 2007 and create a new spreadsheet<li>enter 10, hit tab, 20, hit tab, 30<li>select those 3 cells and insert a chart<li>insert a chart title<li>edit the chart title and give it whatever name you fancy<li>save the spreadsheet (xlsx file)<li>close it, unzip it</ul><p>Here is an excerpt of the chart part xl/charts/chart1.xml :</p><br /><pre style="background-color:#EEEEEE"><br />&lt;c:chartSpace xmlns:c="http://schemas.openxmlformats.org/drawingml/2006/chart"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;xmlns:a="http://schemas.openxmlformats.org/drawingml/2006/main"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships"&gt; <br />&nbsp;&lt;c:lang <b>val="fr-FR"</b>/&gt;<br />&nbsp;&lt;c:chart&gt;<br />&nbsp;&nbsp;&lt;c:title&gt;<br />&nbsp;&nbsp;&nbsp;&lt;c:tx&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&lt;c:rich&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;a:bodyPr/&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;a:lstStyle/&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;a:p&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;a:pPr&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;a:defRPr/&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/a:pPr&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;a:r&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;a:rPr <b>lang="fr-FR"</b>/&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;a:t&gt;Some title&lt;/a:t&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/a:r&gt; <br />...<br /></pre><br /><p>A reader of the article also mentions that within a strict US-English stream, you can get localized text formatting. Here is how :</p><br /><ul><li>start Excel 2007 and create a new spreadsheet<li>click on the Insert ribbon tab and click on Header and Footer<li>type some text in the edit area<li>select some of this text, click on the Home ribbon tab, and put this selection on bold and italic<li>save the spreadsheet (xlsx file)<li>close it, unzip it</ul><p>I am using a French version of Excel 2007. Here is an excerpt of the chart part xl/worksheets/sheet1.xml :</p><br /><pre style="background-color:#EEEEEE"><br />&lt;headerFooter&gt;<br />&nbsp;&lt;oddHeader&gt;&Ctrt&"-,<b>Gras Italique</b>"uiy tuieyrtui&lt;/oddHeader&gt<br />&lt;/headerFooter&gt; <br /></pre><br /><p><b>Gras</b> and <b>Italique</b> are French for <b>Bold</b> and <b>Italic</b>. Just because I am using a French version of Excel 2007, the format produced inserts French localized fragments, therefore anyone willing to read Excel 2007 files in the most general case must be ready to parse non-US English. The ECMA 376 documentation says, in section 3.3.1.36, Part 4, page 1965 (emphasis mine) :</p><br /><pre style="background-color:#EEEEEE"><br />&amp;"font name,font type" - code for "text font name" and "text font type", where <br />font name and font type are strings specifying the name and type of the font, separated <br />by a comma. When a hyphen appears in font name, it means "none specified". Both of font <br />name and font type <b>can be localized values</b>.</pre><br /><p>What <b>can be</b> is supposed to mean? Who reviewed this documentation? And where are the localized values to expect?</p><br /><p>Reading the documentation I have the feeling that :</p><br /><ul><li><b>can be</b> is short for <i>it's complicated, we couldn't get this written on paper in a small space</i><li>the localized names are not provided, so even if I try to do the heavy lifting myself despite the fact that SpreadsheetML violates its own rules (it's supposed to be encoded using US English), where can I get the material to write this library?</ul><br />  <P>&nbsp;</P><br />  <H2>7) Many ways to get in trouble</H2><br />  <P>The extensiveness of the ECMA 376 documentation, over 6000 pages, is telling how much legacy Microsoft is willing to bring into the future. Taking an example of such legacy clarifies what it takes to implement even a portion of the documentation. The example is <EM>text formatting</EM>. Any of the 3 applications, Word, Excel and Powerpoint uses its own text formatting markup. Worse, the shared libraries themselves (VML, DrawingML, MathML, ...) also use separate text formattings, each different. Even worse, if that's possible, Word has many own ways to do text formatting. Excel has many own ways to do text formatting. Powerpoint has many own ways to do text formatting.</P><br />  <P>By "many ways" is meant different markup, sometimes drastically different : in one you could have no country/encoding at all, and in another it's cluttered up with country/encoding markup.</P><br />  <P>If Microsoft were to design a general purpose Office document model (note : ECMA 376 is a description of one specific Office document : Microsoft's), they would have factorized all of this into a single text formatting markup. God only knows why they chose not to do so, keep all the legacy, and try to get away with this mess by making as little publicity as <br />possible about it.</P><br />  <P>Now enter the implementer, or someone willing to make a change to a document. There are three scenarios :</P><br />  <UL><LI>write a document<LI>read a document<LI>read and write the document</UL><br />  <P>The third scenario is just a combination of the others, so there is nothing interesting to say about it.</P><br />  <P>The first scenario is the most simple. To write a document, of a given type, including a given set of objects (from shared languages or not), you only need to write the document in a way that is compatible with the expected XML. In other words, you can use only one text formatting markup model. It's you who decides which one, whether you implement one or more, and so on. So from a writer perspective, you don't suffer the problem very much.</P><br />  <P>Now consider the second scenario. To read a document, you cannot assume what's in that document, therefore you've got to implement all possible combinations of objects that may be part of the document. In particular, you've got to implement all ways to get text formatting markup models because that may well be the XML you face. This is a horrible scenario. To support this scenario, either you are Microsoft, or you have a number of years of work ahead on the subject with plenty of implementation done already. There is no way around, the barrier to entry to this scenario is sky high.</P><br />  <P>Of course, if you read a document, read the markup, and do nothing with it, or nothing of substance with it, it's not quite the same problem. But then, remember that even reading a small chunk of markup can be complicated because of the implicit semantics. You don't need a lot of XML markup to find yourself unable to process it in any meaningful way.</P><br />  <P>To give you an example of how bad the situation is, here is 4 different Excel text formatting markup chunks, all meant to do the same thing (not entirely accurate here, but you get the idea) :</P><br />  <P>1) regular cell formatting</P><br />  <p>&lt;xf numFmtId="0" fontId="2" fillId="0" borderId="0" xfId="0" <br />   applyFont="1"/&gt;&lt;font&gt;&lt;sz val="11"/&gt;&lt;color theme="6" <br />   tint="-0.249977111117893"/&gt;&lt;name val="Calibri"/&gt;&lt;family <br />   val="2"/&gt;&lt;scheme val="minor"/&gt;&lt;/font&gt;</p><br />  <p>2) shared-string cell formatting (note that the shared-string is a technical <br />   artefact surfacing as everyone's problem now)</p><br />  <p><br />   &lt;r&gt;&lt;rPr&gt;&lt;sz val="11"/&gt;&lt;color rgb="FFFF0000"/&gt;&lt;rFont <br />   val="Calibri"/&gt;&lt;family val="2"/&gt;&lt;scheme <br />   val="minor"/&gt;&lt;/rPr&gt;&lt;t&gt;ruir&lt;/t&gt;&lt;/r&gt;</p><br />  <p>3) cell formatting in a conditional alert (note: the conditional alert itself is <br />   declared elsewhere)</p><br />  <p>&lt;dxf&gt;&lt;font&gt;&lt;b/&gt;&lt;i val="0"/&gt;&lt;/font&gt;&lt;numFmt <br />   numFmtId="2" formatCode="0.00"/&gt;&lt;fill&gt;&lt;patternFill <br />   patternType="solid"&gt;&lt;fgColor auto="1"/&gt;&lt;bgColor <br />   rgb="FFFFFFFF"/&gt;&lt;/patternFill&gt;&lt;/fill&gt;&lt;/dxf&gt;</p><br />  <p>4) text formatting in charts</p><br />  <p><br />   &lt;c:rich&gt;&lt;a:bodyPr/&gt;&lt;a:lstStyle/&gt;&lt;a:p&gt;&lt;a:pPr&gt;&lt;a:defRPr/&gt;&lt;/a:pPr&gt;&lt;a:r&gt;&lt;a:rPr <br />   lang="en-US"/&gt;&lt;a:t&gt;t t&lt;/a:t&gt;&lt;/a:r&gt;&lt;a:r&gt;&lt;a:rPr <br />   lang="en-US" sz="1850" u="dash" <br />   baseline="0"&gt;&lt;a:solidFill&gt;&lt;a:schemeClr <br />   val="accent4"&gt;&lt;a:lumMod val="60000"/&gt;&lt;a:lumOff <br />   val="40000"/&gt;&lt;/a:schemeClr&gt;&lt;/a:solidFill&gt;&lt;a:uFill&gt;&lt;a:solidFill&gt;&lt;a:schemeClr <br />   val="accent1"&gt;&lt;a:lumMod val="60000"/&gt;&lt;a:lumOff <br />   val="40000"/&gt;&lt;/a:schemeClr&gt;&lt;/a:solidFill&gt;&lt;/a:uFill&gt;&lt;/a:rPr&gt;&lt;a:t&gt;ruiry&lt;/a:t&gt;&lt;/a:r&gt;&lt;a:r&gt;&lt;a:rPr <br />   lang="en-US"/&gt;&lt;a:t&gt;t <br />   gfgfgfg&lt;/a:t&gt;&lt;/a:r&gt;&lt;/a:p&gt;&lt;/c:rich&gt;</p><br />  <P>&nbsp;</P><br /><p>The beauty about a file format that is impossibly hard to read and update, and is decently easy to write from scratch, is that it fits perfectly in the <i>read-only model</i> that is exactly the reason why Microsoft has a monopoly in Office documents. As a side effect to its proprietary-ness (Office 2007 documents are extensions of ECMA 376 documents), it provides zero interoperability with anything else that exists.</p><br /><p>From a technical marketing perspective, you can always try to start a project that will support ECMA 376, but your chances to complete the project is exactly zero. You can hear about projects starting here and there, you can hear about programs that write documents that can be opened in Office 2007 (note that the only test that can be possibly be made is whether or not Office 2007 opens it, regardless of the flaws of said program, regardless of the impedance mismatch between Office 2007 documents and ECMA 376 documents), but that is not evidence of progress in interoperability across applications and platforms, contrary to what the claims are.</p><br /><p>For instance, to this date there isn't a computer program that perfectly mimics any of the old Microsoft Office versions 97-2000-XP-2003. It just does not exist. In addition to the impossibility of perfectly mimicing a complex and proprietary software, third parties that would go too far supporting the binary file formats would face the wrath of violating Microsoft intellectual property. Example : VBA macros. With Office 2007, Microsoft is bringing all of this forward for backwards compatibility reasons, therefore "opening up" changes nothing. What was proprietary is still proprietary, and barely referenced in ECMA 376.</p><br /><p>&nbsp;</p><br />  <H2>8) Windows dates</H2><br />  <P>Microsoft uses all kinds of date types, not just from one Office application to next, but even at a library level, there are differences. Despite storing document metatadata properties of type date in an ISO compatible format (metadata properties are for instance the creation date of the document), Microsoft insists on using their legacy date types elsewhere. Unfortunately, this has consequences.</P><br />  <P>It's well documented elsewhere that the date type Microsoft uses for spreadsheets is basically flawed for a number of reasons. But what isn't often said is that the date type is actually the OLE date type. Here are the corresponding Windows OLE API functions :</P><br />  <UL><LI><a href="http://msdn2.microsoft.com/en-us/library/ms221440.aspx">VariantTimeToSystemTime</a><br />   <LI><a href="http://msdn2.microsoft.com/en-us/library/ms221646.aspx">SystemTimeToVariantTime</a><br />  </UL><br />  <P>Here is an excerpt of the VariantTimeToSystemTime function documentation, this may sound familiar if you have ever worked with Excel dates.</P><br />  <P><TABLE id="Table3" cellSpacing="1" cellPadding="1" border="1"><TR><br />     <TD valign="top" style="background-color:#EEEEEE"><br />      <P>Converts the variant representation of time to system time values.</P><br />      <PRE>INT VariantTimeToSystemTime( &nbsp;<br />  double  vtime,              <br />  LPSYSTEMTIME  lpSystemTime  <br />);</PRE><br />      <P>A variant time is stored as an 8-byte real value (<B>double</B>), representing a date between January 1, 100 and December 31, 9999, inclusive. The value 2.0 represents January 1, 1900; 3.0 represents January 2, 1900, and so on. Adding 1 to the value increments the date by a day. The fractional part of the value represents the time of day. Therefore, 2.5 represents noon on January 1, 1900; 3.25 represents 6:00 A.M. on January 2, 1900, and so on. Negative numbers represent the dates prior to December 30, 1899.</P><br />      <P>Using the SYSTEMTIME structure is useful because: </P>      <UL>      <LI>It spans all time/date periods. MS-DOS date/time is limited to representing only those dates between 1/1/1980 and 12/31/2107.<LI>The date/time elements are all easily accessible without needing to do any bit decoding.<LI>The National Language Support data and time formatting functions <B>GetDateFormat </B>and <B>GetTimeFormat</B> take a SYSTEMTIME value as input.<LI>It is the default Win32 time and date data format supported by Windows NT and Windows 95.</UL><br />      <P>The <B>VariantTimeToSystemTime</B> function will accept invalid dates and try to fix them when resolving to a VARIANT time. For example, an invalid date such as 2/29/2001 will resolve to 3/1/2001. Only days are fixed, so invalid month values result in an error being returned. Days are checked to be between 1 and 31. Negative days and days greater than 31 results in an error. A day less than 31 but greater than the maximum day in that month has the day promoted to the appropriate day of the next month. A day equal to zero resolves as the last day of the previous month. For example, an invalid dates such as 2/0/2001 will resolve to 1/31/2001.</P><br />     </TD><br />    </TR><br />   </TABLE><br />  </P><br />  <P>&nbsp;</P><br />  <P>As explained, the function makes all kinds of fixup internally, and that's exactly the problem. The date type used in Excel, which is that one, is incompatible with everything else out there, platform-dependent, and undocumented (this documentation describes behaviors, but it does not specify the date type).</P><br />  <p>If Windows dates were replaced by ISO dates, a dependency on Windows would be gone.</p><br />  <P>So, to read a cell containing a date in a spreadsheet and make sense of it implies you are using one of these two OLE API function calls. Even better, there is no cell date type. A cell is either a string, a number, ... but a date is a number with no associated type. In fact, the only way to know the cell contains a date is to lookup and parse the number format that may be associated to that cell. And that's where you enter another black hole.</P><br />  <P>Here is an example of number format :</P><br />  <pre><br />&lt;numFmt numFmtId="171" formatCode="_-* #,##0.00\ _F_-;\-* #,##0.00\ _F_-;_-* "-"??\ _F_-;_-@_-"/&gt;</pre><br />  <P>&nbsp;</P><br />  <P>And another :</P><br />  <pre>&lt;numFmt numFmtId="171" formatCode="[$-40C][Red][&gt;120]_-* #,##0.00\ _F_-;\-* #,##0.00\ _F_-;_-* "-"??\ _F_-;_-@_-"/&gt;</pre><br />  <P>&nbsp;</P><br />  <P>The second one is particularly interesting, it says : use the French locale (40C), if the number is greater than 120, apply red, and do formatting as follow, with plenty of padding/layout special characters (described in the ECMA 376 documentation, but not specified). Implementing those undocumented patterns requires north of 10,000 lines of code, all subject to wild guesses and platform interoperability problems.</P><br /><p>An even more interesting bit is that the XML used in ECMA 376 departs in a number of non-standard ways compared to the XML produced by Excel 2003 (data-only XML). Let's make a comparison.</p><br /><P>To reproduce the scenario :</P><br /><UL><LI>start Excel 2007 and create a new spreadsheet<li>enter <i>11 Jan 2001</i> in a cell (note : translate this date according to your own regional settings)<li>save the spreadsheet (xlsx)<li>save the spreadsheet as Excel 2003-compatible (the exact file type option is <i>XML Spreadsheet 2003 (*.xml)</i>)<li>close it<li>unzip the xlsx package and view the part called xl/worksheets/sheet1.xml<li>open the Excel 2003-compatible XML file</ul><br /><p>Here is the relevant XML you'll see in xl/worksheets/sheet1.xml :</p><br /><pre style="background-color:#EEEEEE"><br />&lt;row r="3" spans="3:3" ht="15" customHeight="1"&gt;<br />&nbsp;&lt;c r="C3" s="1"&gt;<br />&nbsp;&nbsp;&lt;v&gt;36902&lt;/v&gt;<br />&nbsp;&lt;/c&gt;<br />&lt;/row&gt; <br /></pre><br /><p>If you are puzzled by what the value <i>36902</i> might be, it's Excel's Windows date encoding! It is not possible to infer the cell contains a date. You have to explore the number format attached to style s="1" which in turn is described in another part of the package, xl/styles.xml :</p><br /><pre style="background-color:#EEEEEE"><br />&lt;cellXfs count="2"&gt;<br />&nbsp;&lt;xf id="0" numFmtId="0" fontId="0" fillId="0" borderId="0" xfId="0"/&gt;<br />&nbsp;&lt;xf id="1" numFmtId="168" fontId="0" fillId="0" borderId="0" xfId="0" applyNumberFormat="1"/&gt;<br />&lt;/cellXfs&gt;<br /></pre><br /><p>In turn, numFmtId is defined in a separate collection of the same part xl/styles.xml :</p><br /><pre style="background-color:#EEEEEE"><br />&lt;numFmts count="1"&gt;<br />&nbsp;&lt;numFmt numFmtId="168" formatCode="\D\a\t\e\ \:\ d\ mmm\ yyyy"/&gt;<br />&lt;/numFmts&gt; <br /></pre><br /><p>If you parse the proprietary encoding in the number format adequately, you might be able to infer it's a date. To compute the actual date involves more effort, obviously.</p><br /><p>Let's take a look at our Excel-2003 compatible XML :</p><br /><pre style="background-color:#EEEEEE"><br />&lt;Row ss:Index="3" ss:AutoFitHeight="0"&gt;<br />&nbsp;&lt;Cell ss:Index="3" ss:StyleID="s63"&gt;<br />&nbsp;&nbsp;&lt;Data ss:Type="DateTime"&gt;2001-01-11T00:00:00.000&lt;/Data&gt;<br />&nbsp;&lt;/Cell&gt;<br />&lt;/Row&gt;<br /></pre><br /><p>This old Excel 2003 XML is not nearly as bad as the one in ECMA 376. We can infer it's a date thanks to the <i>ss:Type</i> attribute. And, goodness, the date is encoded using <a href="http://en.wikipedia.org/wiki/ISO_8601">ISO 8601</a>, which is definitely a good thing for interoperability purposes.</p><br /><p>The obvious question : why is the new SpreadsheetML using a proprietary date encoding, when Microsoft managed to ship Excel 2003 (this Excel 2003 XML can also be generated with Excel 2007) with dates supporting an international standard encoding, and no need to go into proprietary parsing? Why isn't SpreadsheetML an extension to the old Excel 2003 XML following the same good principles?</p>  <br />  <P>&nbsp;</P><br />  <H2>9) All roads lead to Office 2007</H2><br />  <p>In part 2 of ECMA 376, page 96, we learn :</p><br />  <pre style="background-color:#EEEEEE"><br />Table H&#8211;1. Package model conformance requirements<br /><br />M1.30 The package implementer shall<br />name relationship parts<br />according to the special<br />relationships part naming<br />convention and require that<br />parts with names that conform<br />to this naming convention have<br />the content type for a<br />Relationships part<br />  </pre><br /><p>In theory, this requirement allows unattended part renaming. But this means in practice that some process in the processing chain may reshuffle an entire package on its own, which may break assumptions from other processes of the processing chain.</p><br /><p>Interestingly enough, Excel 2007 takes it to heart to do this reshuffling. If you create a package with part names and relationships that perfectly conform to <i>open packaging conventions</i> as defined by ECMA 376 part 2, then this by no means provide neutrality throughout the entire processing chain, especially if you open the package in Excel 2007 and save it without making changes.</p><br />  <P>To reproduce the scenario :</P><br />  <UL><LI>start Excel 2007 and create a new spreadsheet<br />   <LI>save the spreadsheet (xlsx file)<br />   <LI>close it<br />   <LI>unzip it<br />   <LI>edit [Content_Types].xml part manually, and replace /xl/worksheets/sheet1.xml by /xl/custom/sheet1.xml<br />   <LI>edit xl/_rels/workbook.xml.rels, and replace worksheets/sheet1.xml by custom/sheet1.xml<LI>grab xl/worksheets/sheet1.xml locally as a file<br />   <LI>delete the worksheets "folder"<br />   <LI>create "folder" xl/custom in the package<br />   <LI>add the worksheet part in "folder" xl/custom<br />   <LI>zip it<br />   <LI>open it in Excel 2007<br />   <LI>click save<br />   <LI>close it<br />   <LI>unzip it</UL><br /><p>What you should see is that our custom structure has been replaced with Excel 2007 hardcoded structure. If a business process assumes the existence of a custom structure, it won't work. Why is Excel 2007 reshuffling the package? It's ours!</p><br /><br />  <P>&nbsp;</P><br />  <H2>10)&nbsp;A world of ZIP+OLE files</H2><br />  <P>To reproduce the scenario :</P><br />  <UL><LI>start Excel 2007 and create a new spreadsheet<br />   <LI>click on the Office button, select the Prepare menu option, and then Properties<br />   <LI>enter metadata such as author, title, ...<br />   <LI>click on the Office button, select the Prepare menu option, and then Encrypt Document<LI>enter a password, re-enter the password<LI>save the spreadsheet (xlsx file)<br /><LI>close it</UL><br />  <p>If you try to unzip it, you'll get an error. When you password-protect any Office 2007 document, it becomes an OLE document. Wait a minute, isn't Microsoft moving to ZIP files ?</p><br />  <P>Here is a screenshot of what you should see in an OLE document viewer :</P><br />  <img src="http://www.codeproject.com/useritems/ooxml_is_defective/office2007bin9.gif"><br><br />  <i>A password-protected MS Office 2007 document is a...OLE file, not a ZIP file</i><br><br /><br />  <p>If you roll-over your mouse on the file in Windows Explorer (note : behavior not tested on Windows Vista), you should get a flying tool-tip with just minimal information that is provided by the disk file system, but not the document metadata (author, subject, title, keywords, last modification date, ...)</p><br /><br />  <p>The OLE container contains a number of OLE streams. The document metadata is not available for consumption, meaning that you cannot retrieve this information either. This is a regression compared to binary file formats.</p><br />  <p>In fact, there are two regressions : the document type changes ; the metadata is not accessible. And the password-protection mechanism is undocumented as a whole.</p><br />  <p>Let's see how exactly it compares to an old binary password-protected Excel file.</p><br />  <P>To reproduce the scenario :</P><br />  <UL><LI>start Excel 97 or 2000 or XP or 2003 and create a new spreadsheet<br />   <LI>go in File / Properties<br />   <LI>enter metadata such as author, title, ...<br />   <LI>go in Tools / Options, select the Security tab<br />   <LI>enter a password in field <i>Password to open</i> and click OK, re-enter the password<LI>save the spreadsheet (xls file)<LI>close it</UL><br /><br />  <p>If you roll-over your mouse on the file in Windows Explorer, you should get a flying tool-tip with  <b>all</b> the information that is provided by the disk file system plus <b>all</b> the document metadata (author, subject, title, keywords, last modification date, ...)</p><br /> <br />  <p>Indeed, if we open the xls file in an OLE document viewer, the file structure is kept intact, only the OLE document stream itself is encrypted (contains the encrypted BIFF content). The stream holding the metadata, <i>ISummaryInformation</i>, is left unencrypted. Here is a screenshot of a password-protected binary Excel file in an OLE document viewer :</p><br /><br />  <img src="http://www.codeproject.com/useritems/ooxml_is_defective/DefectiveByDesign5.gif"><br><br />  <i>A legacy password-protected MS Office document is still an OLE file</i><br><br /><br /><p>This has unfortunate consequences for Content Management Servers (CMS). By making the metadata of password-protected Office 2007 documents unavailable, existing CMS workflows are arbitrarily broken. By changing the content type of the document, only because it's password-protected, existing CMS workflows have another reason to break.</p><br /><p>Note : if Microsoft Sharepoint server, or Windows Vista, manages to show the metadata of a password-protected Microsoft Office 2007 document, perhaps it knows something that we don't...</p><br /><br />  <P>&nbsp;</P><br />  <H2>11) Document security is a (bad) joke</H2><br /><P>To reproduce the scenario :</P><br /><UL><LI>start Excel 2007 and create a new spreadsheet (or open an existing spreadsheet).<br /><LI>right-click on the first sheet tab, and select Protect Sheet...<LI>enter a password, hit enter, re-enter the password, hit enter.<LI>try editing cells, you should get an error message.<LI>save, close, unzip.<br />   <LI>edit the zip part named xl/worksheets/sheet1.xml<LI>find the XML element called <b>sheetProtection</b><LI>remove the element <b>sheetProtection</b> and the accompanying attributes (<b>password</b>, <b>sheet</b>, ...).<LI>save the changes and put that part back in the zip file.<LI>open the file in Excel 2007.<LI>try editing some cells, <b><font color=red>it works!</font></b></UL><br /><p>Can you think of a worse document security? We have a format that encrypts buffers into OLE containers when it shouldn't, and leaves XML password hashes right in the ZIP file in such a way that anyone can manually edit the file and remove it.</p><p>When you consider the amount of professional spreadsheet workers out there relying on sheet protection to ensure the integrity of their spreadsheets, you have no idea the impact of this flaw when they learn it...</p><p>There goes another regression with those formats. Note : the Excel binary format had a similar PASSWORD record stored on a per worksheet basis, but the big difference is that none of the target audience is able to edit a binary Excel file. It's binary, therefore it's a form of security by obscurity. And since binary files contain pointers to the stream, removing a record using an hexadecimal editor without taking care of the dirty laundry would automatically result in a corrupt spreadsheet.</p><p>I guess it's fair to say it's a case where document security needs a calculated chain to make such manual changes less easy ! (see the first section of that article to get the irony in full perspective).</p><br /><br />  <P>&nbsp;</P><br />  <H2>12)&nbsp;BIFF is gone...not!</H2><br /><p>BIFF (Binary Interchange File Format) is the name of the Excel binary file format. A BIFF buffer is contained within an OLE container, and consists in a sequence of BIFF records. A BIFF record consists in an identifier, a length to follow, and the corresponding buffer of said BIFF record. BIFF itself is platform-neutral, but of course OLE isn't. Anything stored within BIFF records referencing Windows-specific functions (such as the DEVMODE structure of printer settings) voids any platform-neutral claims. Every Excel release has its own BIFF-specific records. Those set of collective records are called BIFF8 for Excel 97, BIFF9 for Excel 2000, BIFF10 for Excel XP and BIFF11 for Excel 2003.</p><br /><p>One of the claims from the introduction is that ECMA 376 documents are moving to ZIP and XML exclusively. This implies that BIFF is gone. Let's see if that's true.</p><br /><p>(emphasis mine)<br /><pre style="background-color:#EEEEEE"><br />From: Doug Mahugh (Microsoft)<br />Sent: August 21, 2006<br />To: Stephane Rodriguez<br /><br />Stephane,<br /><br />I shared the link with some of the people over in the BIFF12 group today, <br />and they liked the article too. They had some additional info for you which <br />may be of interest.  These sorts of details <b>will all be documented</b> in <br />the BIFF12 documentation that will come out when Office ships, but for now <br />there's <b>no way</b> you could know what's going on for sure (as you explain <br />in the article)<br /><br />(...)<br /><br />Doug Mahugh<br />Office 2007 Technical Evangelist<br />425-707-1182 | MSDN Blog | OpenXmlDeveloper.org<br /></pre><br /></p><br /><p>The subject of matter? This <a href="http://www.codeproject.com/cs/library/office2007bin.asp">article</a>.</p><br /><p>Ironically enough, to this date, the only article shedding a light on BIFF12 available on the internet is this article. Microsoft made no such document available.</p><br /><p>There is more than meets than eye.</p><br /><p>Besides the point that BIFF is actually not gone at all, an even bigger shocker is that BIFF12 is a departure from BIFF11. It's not an extension of BIFF11 with new BIFF records, it's a complete rewrite of all BIFF records, new BIFF record model and new content encoding. So any person who would have invested in a BIFF library (or grabbed it elsewhere), will have to redo that work from scratch. Where is backwards compatibility gone ?</p><br /><p>According to Microsoft's Excel <a href="http://blogs.msdn.com/excel/archive/2006/07/20/671995.aspx">blog</a> :</p><br /><pre style="background-color:#EEEEEE">File Format Number 2 - Excel Binary (XLSB files)<br />The Excel binary format is the second full fidelity format for Excel 2007.  It is<br />similar to the Office Open XML format in structure - a set of related parts, in a <br />zip container - except that instead of each part containing XML, each part contains <br />binary data.<br /><br />Even though we've done a lot of work to make sure that our XML formats open quickly <br />and efficiently, this binary format is still more efficient for Excel to open and <br />save, and can lead to some performance improvements for workbooks that contain a lot <br />of data, or that would require a lot of XML parsing during the Open process.<br /></pre><br /><br /><p>It's hard enough to understand that Microsoft Office is moving to XML, and still away from XML at the same time, but the official justification is performance related. Unfortunately, this justification is just a lie since it is already the justification for the extreme akwardness of the SpreadsheetML XML file format itself. Someone from the Microsoft Office team has <a href="http://blogs.msdn.com/brian_jones/archive/2006/10/26/performance-of-xml-file-formats.aspx">this</a> to say about it :</p><br /><pre style="background-color:#EEEEEE">There are a number of things we looked into doing to help improve the performance of <br />these files (SpreadsheetML) both using current technology as well as thinking about <br />future approaches. Some of the approaches we took that are easiest to understand are:<br /><br />1. Reduce the need to fully parse repeating data - In order to cut back on parsing <br />large strings repeated multiple times, or formulas that are repeated down an entire <br />column, spreadsheetML does a lot of sharing. I already talked about the huge benefits <br />we can get from the shared formulas work in a post last spring. The shared string <br />table can give similar results.<br />2. Tag Size - the size of XML elements actually does directly affect performance times. <br />The more text you have to parse, the longer it will take.<br />3. Splitting the XML into multiple parts - In SpreadsheetML we break the XML content <br />out into multiple parts in the ZIP (each worksheet, the string table, pivot table data, <br />etc.). This can help a ton with on demand loading, or even loading multiple pieces at <br />once. For example, it means that if you had a multi-proc machine, you could load each <br />worksheet on a separate thread. It also means that you could decide to only load on <br />sheet and you wouldn't have to parse through all the XML from the other sheets.<br />4. Relationships stored outside of content - By storing all the relationships from one <br />part to another in separate (and much smaller) files, it makes it really easy to see <br />what other parts you should load when you are loading a particular part of the file. <br />If it weren't for the relationships, you'd actually have to parse through the content <br />of the XML to determine what other resources that part used. For example, if you wanted <br />to just load one slide in a presentation, you can also see what images are used on that <br />slide before you start parsing the XML for the slide. <br /></pre><br /><br /><p>At this point, we are left with the obvious question, if the SpreadsheetML is made much more complex than we would have expected only to cope with performance problems, what is the rationale for the binary workbook (.xlsb) ?</p><br /><p>Microsoft won't tell. There are two reasons however : 1) embarassing reality of XML 2) embarassing reality of ECMA 376</p><br /><br /><p>To illustrate the first untold reality, suffice to create a new spreadsheet, and then query external data. As you do this, Excel 2007 creates a part called the connection data source part, where <b>it stores the connection strings in plain text</b>, among other things. It should be clear by now that connection strings contain sensitive information such as server names, login and passwords. OOps!</p><br /><p>The quick Microsoft solution to this? Security by obscurity, just turn this stuff into binary records (BIFF12), and the problem goes away in theory.</p><br /><p>A similar problem with XML parts is that password hashes are stored in plain-text, as we've seen in the previous section, meaning that armed with a simple text editor, both password hashes and connection string passwords can be edited and/or removed. Vulnerabilities by design?</p><br /><p>The embarassing fact for ECMA 376 is that since this is supposed to be XML only, the new binary workbook, despite being the official answer to the "plain-text" problem, cannot be part of said documentation otherwise automatically violating the claim that those documents are made with XML.</p><br /><p>Last but not least, a pseudo-rebuttal was posted to address the lack of availability of the BIFF12 documentation, a minor problem in comparison to the XML violation rules by the way. This pseudo-rebuttal was explaining that the documentation of binary formats can be freely obtained. Here is the corresponding <a href="http://support.microsoft.com/kb/840817">article</a>. In which we learn :</p><br /><pre style="background-color:#EEEEEE">Microsoft makes its .doc, .xls, and .ppt binary file format specifications <br />available under a royalty-free covenant not to sue to anyone who wishes to <br />implement all or part of these specifications in their products. <br /><b>Implementation includes the ability to use the specification documentation <br />for analysis and forensic reference purposes</b>. Microsoft Office Drawing File <br />Format for 2007 and Visual Basic for Applications (VBA) File Format for 2007 are <br />also available under this program.<br /></pre><br /><p>No right to create a competing product.</p><br /><p>As for whether Microsoft responds at all to any such documentation request, it remains to be seen. Last but not least, whether the documentations contain material that are required even for just analysis or forensic purposes remains to be seen. Microsoft used to distribute those documentations as part of the MSDN Library, until February 1998 (right when Mr Gates had a pinch for Office documents viewed in Internet Explorer). Those documentations are incomplete, often just descriptive, and full of typos. In fact, just as the ECMA 376 documentation itself.</p><br /><p><B>Now enter BIFF11+</B>. Yes, you heard that right! Microsoft created not just one new BIFF file format, it has also taken the time to extend BIFF11 (i.e. Excel 2003's BIFF file format) to include new BIFF records. What for ?</p><br /><p>The reason is round-tripping of spreadsheets. Imagine you are creating a new Excel 2007 spreadsheet using some of the new features, such as the formatting databar (a bar chart drawn inside cells). Then save this file as a Excel 97-2003 compatible file in order to facilitate the collaboration with others (not using Excel 2007). What you still expect is that this file preserves those features. That's exactly what BIFF11+ does, just that Microsoft hasn't considered documenting those new BIFF records, not even talking about it by the way.</p><br /><P>To reproduce the scenario :</P><br /><UL><LI>start Excel 2007 and create a new spreadsheet (or open an existing spreadsheet).<LI>enter values 10,20,30,40,50 in separate cells, then click on the ribbon on the Style button, Conditional Formatting, Data bars, and then pick a color gradient.<li>save the spreadsheet as a <code>Excel 97-2003 Workbook (*.xls)</code><li>a prompt warns that there is going to be a significant loss. Click Continue.<li>open the .xls file with any older version of Excel (97/2000/XP/2003)<li>the file opens with no prompt, and the databar does not show up (which was expected).<li>enter value 60 next to the other cells, and save the file as a regular .xls file, just like it is.<li>open this file in Excel 2007 : the databar magically shows up. The databar however does not include the value we just entered, meaning that we have created a discrepancy.</ul><br /><p>How can the databar show up at all in Excel 2007 since we went through two independent .xls writing phases (one with Excel 2007, one with Excel 97/2000/XP/2003) ?</p><br /><p>You guessed it, new BIFF11+ records are created and preserved. None of that is documented, meaning that this round-trip scenario only works with Microsoft Office. It works as follows :</p><br /><ul><li>when Excel 2007 creates a Excel 97-2003 workbook (*.xls), it actually creates a BIFF11+ file. Because BIFF11+ is an extension of BIFF11, it can be opened in Excel 97, 2000, XP and 2003.<li>and because how BIFF works (any record in the header and footer of internal sections is preserved as is), it allows to do a save in Excel 97, 2000, XP and 2003 without killing those new records.<li>since Microsoft created such new BIFF records to represent the new features : theme, databars, new visual candy in charts, ... but none of it is documented, it follows that interoperability across those file formats is exclusive to them.<li>BIFF11+ records are not a subset of BIFF12 records. Implementers will have to implement/preserve BIFF11+ records and BIFF12 records.<li>we have a discrepancy in the databar that is left for actual spreadsheet users to worry about. The value 60 is left disconnected to the formatting databar, even in Excel 2007.</ul><br /><p>To close up the discussion about BIFF, let's just take a look at an example of BIFF11+, actually just an excerpt from a file (in red, the new BIFF11+ records) :</p><br /><pre style="background-color:#EEEEEE"><br />[DIMENSIONS 000E]  01 00 00 00 06 00 00 00 01 00 02 00 00 00<br />[ROW 0010]  01 00 01 00 02 00 2C 01 00 00 00 00 00 01 0F 00<br />[ROW 0010]  02 00 01 00 02 00 2C 01 00 00 00 00 00 01 0F 00<br />[ROW 0010]  03 00 01 00 02 00 2C 01 00 00 00 00 00 01 0F 00<br />[ROW 0010]  04 00 01 00 02 00 2C 01 00 00 00 00 00 01 0F 00<br />[ROW 0010]  05 00 01 00 02 00 2C 01 00 00 00 00 00 01 0F 00<br />[FLOAT 000A]  01 00 01 00 0F 00 00 00 24 40<br />[FLOAT 000A]  02 00 01 00 0F 00 00 00 34 40<br />[FLOAT 000A]  03 00 01 00 0F 00 00 00 3E 40<br />[FLOAT 000A]  04 00 01 00 0F 00 00 00 44 40<br />[FLOAT 000A]  05 00 01 00 0F 00 00 00 49 40<br />[DBCELL 000E]  AA 00 00 00 50 00 0E 00 0E 00 0E 00 0E 00<br />[WINDOW2 0012]  B6 06 00 00 00 00 40 00 00 00 00 00 00 00 00 00 00 00<br />[SELECTION 000F]  03 01 00 01 00 00 00 01 00 01 00 05 00 01 01<br />[00EF 0006]  00 00 37 00 00 00<br /><font color=red><b>[0867 0017]  67 08 00 00 00 00 00 00 00 00 00 00 02 00 01 FF FF FF FF 03 44 00 00</b></font><br /><font color=red><b>[089C 0026]  9C 08 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 <br />00 00 00 3C 33 00 00 00 00 00 00 00 00</b></font><br /><font color=red><b>[088B 0010]  8B 08 00 00 00 00 00 00 00 00 00 00 00 00 02 00</b></font><br /><font color=red><b>[0879 0022]  79 08 01 00 01 00 05 00 01 00 01 00 01 00 03 00 01 00 05 00 01 00 01 00 01 <br />00 01 00 05 00 01 00 01 00</b></font><br /><font color=red><b>[087A 004C]  7A 08 00 00 00 00 00 00 00 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 <br />00 01 01 00 03 00 10 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 2A 00 00 01 0A 5A 02 00 00 00 FF 55 5A <br />FF 00 00 00 00 00 00 00 00 02 00 00 03 00 00</b></font><br />[EOF 0000] <br /></pre><br /><p>We thought BIFF was gone, and in fact now we have BIFF11+ and BIFF12. Great progress on the interoperability front...</p><br />  <P>&nbsp;</P><br />  <H2>13)&nbsp;Document backwards compatibility subject to neutrino radio-activity</H2><br />  <p>Here is a <a href="http://xlsgen.arstdesign.com/special/Chart97_BreakingChange2007.xls">simple chart</a> created with Excel 2003. Open it with any of Excel 97/2000/XP/2003, then open it in Excel 2007. Microsoft said they could not change the internal structure of Excel spreadsheets (and other Office document types) because they had to provide 100% full fidelity otherwise their customers would not want it. Is this true?</p><br /><table><tr><br /><td><img src="http://www.codeproject.com/useritems/ooxml_is_defective/ChartExcel2003.jpg"><br><i>A simple chart in Excel 2003</i></td><td><img src="http://www.codeproject.com/useritems/ooxml_is_defective/ChartExcel2007.jpg"><br><i>Same file opened in Excel 2007</i></td><br /></tr></table><br /><p>The differences are :</p><br /><ul><li>vertical axis all set to automatic scale/min/max.<br /><li>also impacts the number of<br />horizontal gridlines in the background.<br /><li>chart title font not the same weight<br /><li>chart title incorrectly positioned vertically.<br /><li>legend border incorrect.<br /><li>legend entries incorrectly positioned.<br /><li>spacing between the plot area and the legend.<br /></ul><br /><p>&lt;sarcasm&gt;Programs used by hundreds of millions people need no special attention, that goes without saying....&lt;/sarcasm&gt;</p><br /><p>Good luck programming charts. Microsoft provides no documented mapping between the Escher library (pre-Office 2007 era) and the DrawingML+VML libraries (Office 2007 era, before it gets dropped to something else in the future). Is there possibly a reason why?</p><br /><p>Answer : Microsoft has dropped the existing chart drawing engine in favor of a new library. It is impossible in practice to rewrite a library with new source code, <b>a new agenda (visual candy)</b>, and manage to get 100% full fidelity with the past. This results in unproper drawing of <b>existing</b> charts. Which means, in other words :</p><br /><ul><li>Microsoft is lying, the part of ECMA 376 documentation describing charts does not 100% map the old chart drawing spec.<br /><li>The implementation itself is buggy, an automatic consequence of the first point<br /></ul><br /><P>&nbsp;</P><br />  <H2>14)&nbsp;ECMA 376 documents just do not exist</H2><br />  <P>Last but not least, ECMA 376 documents just do not exist. <br />   The reason why is manyfolds :</P><br />  <UL><LI>Office 2007 documents are derived from theoretical ECMA 376 documents, to which is added <a href="http://www.codeproject.com/cs/library/office2007bin.asp">binary parts</a>, macros, OLE objects, ActiveX serialization, DRM, sharepoint metadata, ...<br />   <LI>Office 2007 documents are incompatible with theoretical ECMA 376 documents, since the ECMA 376 documentation says among other things that VML is deprecated, and Office 2007 documents are still using plenty of it when creating new documents.<br />   <LI>Microsoft strategy itself is to provide as little information as possible about the huge impedance mismatch between ECMA 376 and the actual implementation. Expect ECMA 376 to evolve only marginally, while Office 2007 next version will come with plenty more of Microsoft proprietary layers, especially those integrating the Microsoft Office suite with Windows (on the client), more undocumented integration points between Microsoft Office, Windows and Sharepoint (on the server), more undocumented client-server protocols (between the Microsoft Office client, and servers running Microsoft server software).</LI></UL><br /><p>These are blatant elements why the ISO submission is actually a diversion. If you think the elements above are not enough, consider the following <a href="http://blogs.msdn.com/brian_jones/archive/2007/07/12/spreadsheet-formula-bugs.aspx">response</a> from Brian Jones, Microsoft employee and authoritative voice on Microsoft Office XML formats : (emphasis mine)</p><br /><pre style="background-color:#EEEEEE"><br />To your last point [It would be good if Microsoft would state offically it's intent <br />to support future development and improvement of the standard in Ecma of new version <br />of the format and that it intents those version to get simular open licensing.], <br /><B>it's hard for Microsoft to commit to what comes out of Ecma</B> in the coming years, <br />because we don't know what direction they will take the formats. We'll of course stay <br />active and propose changes based on where we want to go with Office 14. At the end of <br />the day though, the other Ecma members could decide to take the spec in a completely <br />different direction. Now my impression is that won't happen, as the folks on the TC [<B>Ecma<br />Technical group Committee, in which Microsoft is the...armchair</B>] all have pretty similar <br />visions for the future of the spec, but since it's not guaranteed it would be hard for <br />us to make any sort of official statement.</pre><br /><br />  <P>&nbsp;</P><br /><H2>15) How the ISO OpenDocument format (ODF) compares?</H2><br /><p>When I wrote this article, I wanted it to focus on Microsoft Office XML formats exclusively, but Microsoft apologists out there running out of arguments to find a justification as to why Microsoft Office XML formats are that bad, turned to the typical rhetoric, started sending piques at the ISO OpenDocument format (ODF). I thought, well, let's do a quick comparison on all the points above. Results are as follows :</p><br /><ul><li><i>Self-exploding spreadsheets</i> : I have created a <a href="http://diffopc.arstdesign.com/diffopc_sample_odf_2/diffopc.html">visual diff</a> of two ODF spreadsheets, before and after the modification of a cell containing a formula. And sure enough, there is no calculation chain, which means it's easy to make manual changes to existing ODF files, no hassles, you don't have to care about the format's own dirty laundry. And to remove the formula, you just remove the corresponding XML formula attribute in that cell. <code><font color=red><b>ODF : 1, ECMA 376 : 0</b></font></code><br /><li><i>Entered versus stored values</i> : the entered values are stored as is. There is no rounding error. ODF goes as far as storing both the entered value and the displayed value (after the number format is applied) which is a wonderful thing for those willing to extract data. <code><font color=red><b>ODF : 2, ECMA 376 : 0</b></font></code><br /><li><I>Optimization artefacts</I> : there is no such thing as a shared formula concept in ODF. I guess ODF needs not be encumbered with optimization techniques that were valid 20 years ago, when computers were a thousand times less powerful than right now. <code><font color=red><b>ODF : 3, ECMA 376 : 0</b></font></code><br /><li><I>VML isn't XML</I> : there is no VML or anything fundamentally non-XML in ODF. If you create a note in an ODF file, the corresponding XML fragment is :<br /><pre style="background-color:#EEEEEE"><br />&lt;office:annotation office:display="true" draw:style-name="gr1" draw:text-style-name="P1" <br />                   <b>svg:width="2.899cm" svg:height="0.596cm" svg:x="7.374cm" svg:y="0.307cm"</b> <br />                   draw:caption-point-x="-0.61cm" draw:caption-point-y="1.5cm"&gt;<br />&nbsp;&nbsp;&lt;dc:creator&gt;sr&lt;/dc:creator&gt;<br />&nbsp;&nbsp;&lt;dc:date&gt;2007-09-02T00:00:00&lt;/dc:date&gt;<br />&nbsp;&nbsp;&lt;text:p text:style-name="P1"&gt;some comment&lt;/text:p&gt;<br />&lt;/office:annotation&gt;<br /></pre><br />This is proper XML, one value per attribute, the fragment is full in-context in the stream. Plus, you can grab an existing SVG library to make sense of the XML, no need to implement a single vendor's soup. <code><font color=red><b>ODF : 4, ECMA 376 : 0</b></font></code><br /><li><i>Open packaging parts minefield</i> : there is no such thing as a tree of parts. Instead, ODF has a central directory whose management is deterministic and in fact trivial. In retrospect, why did Microsoft went with such a problematic concept of a tree part with undeterministic relations? Was it because strictly copying ODF was embarassing (Not-Invented-Here syndrome) ? <code><font color=red><b>ODF : 5, ECMA 376 : 0</b></font></code><br /><li><I>International, but US English</I> : everything is stored <i>uniformly</i> in US English, there is no discrepancy. The locale is applied as per the style definitions, separate from the data, which is a good design in decoupling that implementers can take advantage of (smaller implementations, less prone to errors, especially in a global market context). <code><font color=red><b>ODF : 6, ECMA 376 : 0</b></font></code><br /><li><I>Many ways to get in trouble</I> : ODF defines a single style concept across the entire formats. So not only any Word, Spreadsheet or Presentation document has a single style concept instead of many. But both document types share the same style concept. This translates in interoperable formatting across applications and platforms, plus small implementations. Contrary to ECMA 376, implementers don't have to implement more than 15 years of formatting legacy. <code><font color=red><b>ODF : 7, ECMA 376 : 0</b></font></code><br /><li><I>Windows dates</I> : ODF stores ISO 8601 dates, which makes it easy for implementers to interoperate on any application or platform. Here is the following XML fragment when entering date <code>11/01/2001 03:45:20</code> : <code><font color=red><b>ODF : 8, ECMA 376 : 0</b></font></code><br /><pre style="background-color:#EEEEEE"><br />&lt;table:table-cell table:style-name="ce1" office:value-type="<b>date</b>" <br />                  office:date-value="<b>2001-01-11T03:45:20</b>"&gt;<br />  &lt;text:p&gt;11/01/2001 03:45:20&lt;/text:p&gt;<br />&lt;/table:table-cell&gt;<br /></pre><br /><li><I>All roads lead to Office 2007</I> : ODF also destroys any custom part name. <code><font color=red><b>ODF : 8, ECMA 376 : 1</b></font></code><br /><li><I>A world of ZIP+OLE files</I> : After encryption, an ODF file is still an ODF file (i.e. ZIP, XML). ODF encrypts the content part (using a standard algorithm described in the manifest part). The metadata part is left unencrypted. <code><font color=red><b>ODF : 9, ECMA 376 : 1</b></font></code><br /><li><I>Document security</I> : ODF does the same, it saves a password hash that can by manually removed. <code><font color=red><b>ODF : 9, ECMA 376 : 2</b></font></code><br /><li><I>BIFF is gone</I> : ODF is ZIP and XML. If you insert or import an OLE object, it's saved as a binary part, just like ECMA 376 does, but the ODF streams themselves are still XML. <code><font color=red><b>ODF : 10, ECMA 376 : 2</b></font></code><br /><li><I>Document backwards compatibility</I> : I've installed the oldest OpenOffice release I could get (1.0.3, released in 2003), loaded the same chart as in the example, saved as an .SXC filme (this was the name extension before it became  an .ODS file later), then loaded the .SXC file in the OpenOffice 2.2. The chart is exactly the same in both versions. <code><font color=red><b>ODF : 11, ECMA 376 : 2</b></font></code><br /><li><I>ECMA 376 documents do not exist</I> : No hidden intellectual property since it's a 100% open-source project in GPL. <code><font color=red><b>ODF : 12, ECMA 376 : 2</b></font></code><br /></ul><br /><H3>Final score : <code><font color=red><b>ODF : 12, ECMA 376 : 2</b></font></code></H3><br /><p>To better cope with those problems, ECMA 376 will have to be redesigned to something that is pretty much what ODF does. Why isn't Microsoft extending ODF instead of reinventing a bad wheel ? Customers would benefit a great deal of a single standard.</p><br />  <P>-St&eacute;phane Rodriguez, <i>August 2007</i><br>Independent software vendor, file format expert<br>Not affiliated to any pro-MS or anti-MS party/org/ass.</P><br />  <P>&nbsp;</P><br />  <i>Update : this article was Slashdotted on Sunday 26 of August.</i><br />  <i>Update2 : this article is taking 300,000 hits a day, and is making it all around the world in all kinds of sites. My web host provider was so angry at the peak in traffic that he threatened to cut me off, so I had to redirect to a blog site such as Google's blogger to host the article.</i><br />  <i>Update3 : wednesday august 29, added a new section on Document security</i><br />  <i>Update4 : friday august 31, added more content to sections US English and Windows dates</i><br />  <i>Update5 : sunday september 2, added a quick comparison between ODF and ECMA 376</i><br />  <P>&nbsp;</P><br /><script src="http://www.google-analytics.com/urchin.js" type="text/javascript"></script><script type="text/javascript">_uacct = "UA-792914-6";urchinTracker();</script></p>
      <div style='clear: both;'></div> 
    </div>
    <div class='post-footer'>
    <p class='post-footer-line post-footer-line-1'>
      <span class='post-author vcard'>
        
          Posted by
          <span class='fn'>OOXML is defective by design</span>
        
      </span>

      <span class='post-timestamp'>
        
          at
        
          <a class='timestamp-link' href='http://ooxmlisdefectivebydesign.blogspot.com/2007/08/microsoft-office-xml-formats-defective.html' rel='bookmark' title='permanent link'><abbr class='published' title='2007-08-28T08:27:00-07:00'>8:27 AM</abbr></a>
        
        
      </span>

      <span class='post-comment-link'>
        

          
        
      </span>

       
       <span class='post-backlinks post-comment-link'>
         
           
         
       </span>

      <span class='post-icons'>
        
        

        
        
  
    <span class='item-control blog-admin pid-2136527318'>
      <a href='http://www.blogger.com/post-edit.g?blogID=283390674923940532&postID=7772935878076524105' title='Edit Post'>
        <span class='quick-edit-icon'>&#160;</span>
      </a>
    </span>
  

      </span>
      </p>

      <p class='post-footer-line post-footer-line-2'>
      <span class='post-labels'>
        
      </span>
      </p>

      <p class='post-footer-line post-footer-line-3'></p>
    </div>
  </div>

      
      
    
    <!-- google_ad_section_end -->
  </div>

  
  
  <div class='blog-pager' id='blog-pager'>
    

    

    
      
    

  </div>
  <div class='clear'></div>


  
  
   
    
      <div class='blog-feeds'>
        
  <div class='feed-links'>
  Subscribe to:
  
     <a class='feed-link' href='http://ooxmlisdefectivebydesign.blogspot.com/feeds/posts/default' target='_blank' type='application/atom+xml'>Posts (Atom)</a>
  
  </div>

      </div>
    

    

</div></div>
  </div>
<script type='text/javascript'>
_WidgetManager._Init('http://www.blogger.com/rearrange?blogID=283390674923940532', 'http://ooxmlisdefectivebydesign.blogspot.com/','283390674923940532');
_WidgetManager._SetPageActionUrl('http://www.blogger.com/display?blogID=283390674923940532', 'MjayzSBW9XR9WIm6s_qYu10fb-k=:1190988428494');
_WidgetManager._SetDataContext([{'name': 'blog', 'data': {'title': 'OOXML is defective by design', 'pageType': 'index', 'url': 'http://ooxmlisdefectivebydesign.blogspot.com/', 'homepageUrl': 'http://ooxmlisdefectivebydesign.blogspot.com/', 'pageTitle': 'OOXML is defective by design', 'encoding': 'UTF-8', 'isPrivate': false, 'languageDirection': 'ltr', 'feedLinks': '\u003clink rel\u003d\"alternate\" type\u003d\"application/atom+xml\" title\u003d\"OOXML is defective by design - Atom\" href\u003d\"http://ooxmlisdefectivebydesign.blogspot.com/feeds/posts/default\" /\>\n\u003clink rel\u003d\"alternate\" type\u003d\"application/rss+xml\" title\u003d\"OOXML is defective by design - RSS\" href\u003d\"http://ooxmlisdefectivebydesign.blogspot.com/feeds/posts/default?alt\u003drss\" /\>\n\u003clink rel\u003d\"service.post\" type\u003d\"application/atom+xml\" title\u003d\"OOXML is defective by design - Atom\" href\u003d\"http://www.blogger.com/feeds/283390674923940532/posts/default\" /\>\n\u003clink rel\u003d\"EditURI\" type\u003d\"application/rsd+xml\" title\u003d\"RSD\" href\u003d\"http://www.blogger.com/rsd.g?blogID\u003d283390674923940532\" /\>'}}]);
_WidgetManager._SetSystemMarkup({'layout': {'varName': '', 'template': '\u003cdiv class\u003d\'widget-wrap1\'\>  \u003cdiv class\u003d\'widget-wrap2\'\> \u003cdiv class\u003d\'widget-wrap3\'\> \u003cdiv class\u003d\'widget-content\'\> \u003cdiv class\u003d\'layout-title\'\>\u003cdata:layout-title\>\u003c/data:layout-title\>\u003c/div\> \u003ca class\u003d\'editlink\' expr:href\u003d\'data:widget.quickEditUrl\' expr:onclick\u003d\'\"return _WidgetManager._PopupConfig(document.getElementById(\\\"\" +       data:widget.instanceId + \"\\\"));\"\' target\u003d\'chooseWidget\'\>\u003cdata:edit-link\>\u003c/data:edit-link\>\u003c/a\> \u003c/div\> \u003c/div\> \u003c/div\> \u003c/div\>'}, 'quickedit': {'varName': '', 'template': '\u003cdiv class\u003d\'clear\'\>\u003c/div\> \u003cspan class\u003d\'widget-item-control\'\> \u003cspan class\u003d\'item-control blog-admin\'\> \u003ca class\u003d\'quickedit\' expr:href\u003d\'data:widget.quickEditUrl\' expr:onclick\u003d\'\"return _WidgetManager._PopupConfig(document.getElementById(\\\"\" +       data:widget.instanceId + \"\\\"));\"\' expr:target\u003d\'\"config\" + data:widget.instanceId\' expr:title\u003d\'data:edit-link\'\> \u003cspan class\u003d\'quick-edit-icon\'\>&#160;\u003c/span\> \u003c/a\> \u003c/span\> \u003c/span\> \u003cdiv class\u003d\'clear\'\>\u003c/div\>'}, 'all-head-content': {'varName': 'page', 'template': '\u003cmeta expr:content\u003d\'\"text/html; charset\u003d\" + data:page.encoding\' http-equiv\u003d\'Content-Type\'/\> \u003cmeta content\u003d\'true\' name\u003d\'MSSmartTagsPreventParsing\'/\> \u003cmeta content\u003d\'blogger\' name\u003d\'generator\'/\> \u003cdata:blog.feedLinks\>\u003c/data:blog.feedLinks\> \u003cb:if cond\u003d\'data:page.isPrivate\'\> \u003cmeta content\u003d\'NOINDEX,NOFOLLOW\' name\u003d\'robots\'/\> \u003c/b:if\>'}});
_WidgetManager._RegisterWidget('_NavbarView', new _WidgetInfo('Navbar1',  'navbar',{'main': {'varName': '', 'template': '&lt;iframe src\u003d&quot;http://www.blogger.com/navbar.g?targetBlogID\u003d283390674923940532&amp;amp;blogName\u003dOOXML+is+defective+by+design&amp;amp;publishMode\u003dPUBLISH_MODE_BLOGSPOT&amp;amp;navbarType\u003dBLUE&amp;amp;layoutType\u003dLAYOUTS&amp;amp;homepageUrl\u003dhttp%3A%2F%2Fooxmlisdefectivebydesign.blogspot.com%2F&amp;amp;searchRoot\u003dhttp%3A%2F%2Fooxmlisdefectivebydesign.blogspot.com%2Fsearch&quot; marginwidth\u003d&quot;0&quot; marginheight\u003d&quot;0&quot; scrolling\u003d&quot;no&quot; frameborder\u003d&quot;0&quot; height\u003d&quot;30px&quot; width\u003d&quot;100%&quot; id\u003d&quot;navbar-iframe&quot;&gt;&lt;/iframe&gt; &lt;div id\u003d&quot;space-for-ie&quot;&gt;&lt;/div&gt;'}}, document.getElementById('Navbar1'), {}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_HeaderView', new _WidgetInfo('Header1',  'main',{'main': {'varName': '', 'template': '\u003cb:if cond\u003d\'data:useImage\'\> \u003cb:if cond\u003d\'data:imagePlacement \u003d\u003d \"REPLACE\"\'\>  \u003cdiv id\u003d\'header-inner\'\> \u003ca expr:href\u003d\'data:blog.homepageUrl\' style\u003d\'display: block\'\> \u003cimg expr:alt\u003d\'data:title\' expr:height\u003d\'data:height\' expr:id\u003d\'data:widget.instanceId + \"_headerimg\"\' expr:src\u003d\'data:sourceUrl\' expr:width\u003d\'data:width\' style\u003d\'display: block\'/\> \u003c/a\> \u003c/div\> \u003cb:else\>\u003c/b:else\>  \u003cdiv expr:style\u003d\'\"background-image: url(\\\"\" + data:sourceUrl + \"\\\"); \"                      + \"background-repeat: no-repeat; \"                      + \"width: \" + data:width + \"px; \"                      + \"height: \" + data:height + \"px;\"\' id\u003d\'header-inner\'\> \u003cdiv class\u003d\'titlewrapper\' style\u003d\'background: transparent\'\> \u003ch1 class\u003d\'title\' style\u003d\'background: transparent; border-width: 0px\'\> \u003cb:if cond\u003d\'data:blog.url \u003d\u003d data:blog.homepageUrl\'\> \u003cdata:title\>\u003c/data:title\> \u003cb:else\>\u003c/b:else\> \u003ca expr:href\u003d\'data:blog.homepageUrl\'\>\u003cdata:title\>\u003c/data:title\>\u003c/a\> \u003c/b:if\> \u003c/h1\> \u003c/div\> \u003cdiv class\u003d\'descriptionwrapper\'\> \u003cp class\u003d\'description\'\>\u003cspan\>\u003cdata:description\>\u003c/data:description\>\u003c/span\>\u003c/p\> \u003c/div\> \u003c/div\> \u003c/b:if\> \u003cb:else\>\u003c/b:else\>  \u003cdiv id\u003d\'header-inner\'\> \u003cdiv class\u003d\'titlewrapper\'\> \u003ch1 class\u003d\'title\'\> \u003cb:if cond\u003d\'data:blog.url \u003d\u003d data:blog.homepageUrl\'\> \u003cdata:title\>\u003c/data:title\> \u003cb:else\>\u003c/b:else\> \u003ca expr:href\u003d\'data:blog.homepageUrl\'\>\u003cdata:title\>\u003c/data:title\>\u003c/a\> \u003c/b:if\> \u003c/h1\> \u003c/div\> \u003cdiv class\u003d\'descriptionwrapper\'\> \u003cp class\u003d\'description\'\>\u003cspan\>\u003cdata:description\>\u003c/data:description\>\u003c/span\>\u003c/p\> \u003c/div\> \u003c/div\> \u003c/b:if\>'}}, document.getElementById('Header1'), {}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_BlogView', new _WidgetInfo('Blog1',  'main',{'main': {'varName': 'top', 'template': '\u003cdiv class\u003d\'blog-posts hfeed\'\> \u003cb:include data\u003d\'top\' name\u003d\'status-message\'\>\u003c/b:include\> \u003cdata:adStart\>\u003c/data:adStart\> \u003cb:loop values\u003d\'data:posts\' var\u003d\'post\'\> \u003cb:if cond\u003d\'data:post.dateHeader\'\> \u003ch2 class\u003d\'date-header\'\>\u003cdata:post.dateHeader\>\u003c/data:post.dateHeader\>\u003c/h2\> \u003c/b:if\> \u003cb:include data\u003d\'post\' name\u003d\'post\'\>\u003c/b:include\> \u003cb:if cond\u003d\'data:blog.pageType \u003d\u003d \"item\"\'\> \u003cb:include data\u003d\'post\' name\u003d\'comments\'\>\u003c/b:include\> \u003c/b:if\> \u003cb:if cond\u003d\'data:post.includeAd\'\> \u003cdata:adEnd\>\u003c/data:adEnd\> \u003cdata:adCode\>\u003c/data:adCode\> \u003cdata:adStart\>\u003c/data:adStart\> \u003c/b:if\> \u003c/b:loop\> \u003cdata:adEnd\>\u003c/data:adEnd\> \u003c/div\>  \u003cb:include name\u003d\'nextprev\'\>\u003c/b:include\>  \u003cb:include name\u003d\'feedLinks\'\>\u003c/b:include\>'}, 'nextprev': {'varName': '', 'template': '\u003cdiv class\u003d\'blog-pager\' id\u003d\'blog-pager\'\> \u003cb:if cond\u003d\'data:newerPageUrl\'\> \u003cspan id\u003d\'blog-pager-newer-link\'\> \u003ca class\u003d\'blog-pager-newer-link\' expr:href\u003d\'data:newerPageUrl\' expr:id\u003d\'data:widget.instanceId + \"_blog-pager-newer-link\"\' expr:title\u003d\'data:newerPageTitle\'\>\u003cdata:newerPageTitle\>\u003c/data:newerPageTitle\>\u003c/a\> \u003c/span\> \u003c/b:if\> \u003cb:if cond\u003d\'data:olderPageUrl\'\> \u003cspan id\u003d\'blog-pager-older-link\'\> \u003ca class\u003d\'blog-pager-older-link\' expr:href\u003d\'data:olderPageUrl\' expr:id\u003d\'data:widget.instanceId + \"_blog-pager-older-link\"\' expr:title\u003d\'data:olderPageTitle\'\>\u003cdata:olderPageTitle\>\u003c/data:olderPageTitle\>\u003c/a\> \u003c/span\> \u003c/b:if\> \u003cb:if cond\u003d\'data:blog.homepageUrl !\u003d data:blog.url\'\> \u003ca class\u003d\'home-link\' expr:href\u003d\'data:blog.homepageUrl\'\>\u003cdata:homeMsg\>\u003c/data:homeMsg\>\u003c/a\> \u003cb:else\>\u003c/b:else\> \u003cb:if cond\u003d\'data:newerPageUrl\'\> \u003ca class\u003d\'home-link\' expr:href\u003d\'data:blog.homepageUrl\'\>\u003cdata:homeMsg\>\u003c/data:homeMsg\>\u003c/a\> \u003c/b:if\> \u003c/b:if\> \u003c/div\> \u003cdiv class\u003d\'clear\'\>\u003c/div\>'}, 'post': {'varName': 'post', 'template': '\u003cdiv class\u003d\'post hentry uncustomized-post-template\'\> \u003ca expr:name\u003d\'data:post.id\'\>\u003c/a\> \u003cb:if cond\u003d\'data:post.title\'\> \u003ch3 class\u003d\'post-title entry-title\'\> \u003cb:if cond\u003d\'data:post.link\'\> \u003ca expr:href\u003d\'data:post.link\'\>\u003cdata:post.title\>\u003c/data:post.title\>\u003c/a\> \u003cb:else\>\u003c/b:else\> \u003cb:if cond\u003d\'data:post.url\'\> \u003ca expr:href\u003d\'data:post.url\'\>\u003cdata:post.title\>\u003c/data:post.title\>\u003c/a\> \u003cb:else\>\u003c/b:else\> \u003cdata:post.title\>\u003c/data:post.title\> \u003c/b:if\> \u003c/b:if\> \u003c/h3\> \u003c/b:if\> \u003cdiv class\u003d\'post-header-line-1\'\>\u003c/div\> \u003cdiv class\u003d\'post-body entry-content\'\> \u003cp\>\u003cdata:post.body\>\u003c/data:post.body\>\u003c/p\> \u003cdiv style\u003d\'clear: both;\'\>\u003c/div\>  \u003c/div\> \u003cdiv class\u003d\'post-footer\'\> \u003cp class\u003d\'post-footer-line post-footer-line-1\'\> \u003cspan class\u003d\'post-author vcard\'\> \u003cb:if cond\u003d\'data:top.showAuthor\'\> \u003cdata:top.authorLabel\>\u003c/data:top.authorLabel\> \u003cspan class\u003d\'fn\'\>\u003cdata:post.author\>\u003c/data:post.author\>\u003c/span\> \u003c/b:if\> \u003c/span\> \u003cspan class\u003d\'post-timestamp\'\> \u003cb:if cond\u003d\'data:top.showTimestamp\'\> \u003cdata:top.timestampLabel\>\u003c/data:top.timestampLabel\> \u003cb:if cond\u003d\'data:post.url\'\> \u003ca class\u003d\'timestamp-link\' expr:href\u003d\'data:post.url\' rel\u003d\'bookmark\' title\u003d\'permanent link\'\>\u003cabbr class\u003d\'published\' expr:title\u003d\'data:post.timestampISO8601\'\>\u003cdata:post.timestamp\>\u003c/data:post.timestamp\>\u003c/abbr\>\u003c/a\> \u003c/b:if\> \u003c/b:if\> \u003c/span\> \u003cspan class\u003d\'post-comment-link\'\> \u003cb:if cond\u003d\'data:blog.pageType !\u003d \"item\"\'\> \u003cb:if cond\u003d\'data:post.allowComments\'\> \u003ca class\u003d\'comment-link\' expr:href\u003d\'data:post.addCommentUrl\' expr:onclick\u003d\'data:post.addCommentOnclick\'\>\u003cb:if cond\u003d\'data:post.numComments \u003d\u003d 1\'\>1 \u003cdata:top.commentLabel\>\u003c/data:top.commentLabel\>\u003cb:else\>\u003c/b:else\>\u003cdata:post.numComments\>\u003c/data:post.numComments\> \u003cdata:top.commentLabelPlural\>\u003c/data:top.commentLabelPlural\>\u003c/b:if\>\u003c/a\> \u003c/b:if\> \u003c/b:if\> \u003c/span\>  \u003cspan class\u003d\'post-backlinks post-comment-link\'\> \u003cb:if cond\u003d\'data:blog.pageType !\u003d \"item\"\'\> \u003cb:if cond\u003d\'data:post.showBacklinks\'\> \u003ca class\u003d\'comment-link\' expr:href\u003d\'data:post.url + \"#links\"\'\>\u003cdata:top.backlinkLabel\>\u003c/data:top.backlinkLabel\>\u003c/a\> \u003c/b:if\> \u003c/b:if\> \u003c/span\> \u003cspan class\u003d\'post-icons\'\>  \u003cb:if cond\u003d\'data:post.emailPostUrl\'\> \u003cspan class\u003d\'item-action\'\> \u003ca expr:href\u003d\'data:post.emailPostUrl\' expr:title\u003d\'data:top.emailPostMsg\'\> \u003cspan class\u003d\'email-post-icon\'\>&#160;\u003c/span\> \u003c/a\> \u003c/span\> \u003c/b:if\>  \u003cb:include data\u003d\'post\' name\u003d\'postQuickEdit\'\>\u003c/b:include\> \u003c/span\> \u003c/p\> \u003cp class\u003d\'post-footer-line post-footer-line-2\'\> \u003cspan class\u003d\'post-labels\'\> \u003cb:if cond\u003d\'data:post.labels\'\> \u003cdata:postLabelsLabel\>\u003c/data:postLabelsLabel\> \u003cb:loop values\u003d\'data:post.labels\' var\u003d\'label\'\> \u003ca expr:href\u003d\'data:label.url\' rel\u003d\'tag\'\>\u003cdata:label.name\>\u003c/data:label.name\>\u003c/a\>\u003cb:if cond\u003d\'data:label.isLast !\u003d \"true\"\'\>,\u003c/b:if\> \u003c/b:loop\> \u003c/b:if\> \u003c/span\> \u003c/p\> \u003cp class\u003d\'post-footer-line post-footer-line-3\'\>\u003c/p\> \u003c/div\> \u003c/div\>'}, 'postQuickEdit': {'varName': 'post', 'template': '\u003cb:if cond\u003d\'data:post.editUrl\'\> \u003cspan expr:class\u003d\'\"item-control \" + data:post.adminClass\'\> \u003ca expr:href\u003d\'data:post.editUrl\' expr:title\u003d\'data:top.editPostMsg\'\> \u003cspan class\u003d\'quick-edit-icon\'\>&#160;\u003c/span\> \u003c/a\> \u003c/span\> \u003c/b:if\>'}, 'commentDeleteIcon': {'varName': 'comment', 'template': '\u003cspan expr:class\u003d\'\"item-control \" + data:comment.adminClass\'\> \u003ca expr:href\u003d\'data:comment.deleteUrl\' expr:title\u003d\'data:top.deleteCommentMsg\'\> \u003cspan class\u003d\'delete-comment-icon\'\>&#160;\u003c/span\> \u003c/a\> \u003c/span\>'}, 'backlinkDeleteIcon': {'varName': 'backlink', 'template': '\u003cspan expr:class\u003d\'\"item-control \" + data:backlink.adminClass\'\> \u003ca expr:href\u003d\'data:backlink.deleteUrl\' expr:title\u003d\'data:top.deleteBacklinkMsg\'\> \u003cspan class\u003d\'delete-comment-icon\'\>&#160;\u003c/span\> \u003c/a\> \u003c/span\>'}, 'comments': {'varName': 'post', 'template': '\u003cdiv class\u003d\'comments\' id\u003d\'comments\'\> \u003ca name\u003d\'comments\'\>\u003c/a\> \u003cb:if cond\u003d\'data:post.allowComments\'\> \u003ch4\> \u003cb:if cond\u003d\'data:post.numComments \u003d\u003d 1\'\> 1 \u003cdata:commentLabel\>\u003c/data:commentLabel\>: \u003cb:else\>\u003c/b:else\> \u003cdata:post.numComments\>\u003c/data:post.numComments\> \u003cdata:commentLabelPlural\>\u003c/data:commentLabelPlural\>: \u003c/b:if\> \u003c/h4\> \u003cdl id\u003d\'comments-block\'\> \u003cb:loop values\u003d\'data:post.comments\' var\u003d\'comment\'\> \u003cdt class\u003d\'comment-author\' expr:id\u003d\'\"comment-\" + data:comment.id\'\> \u003ca expr:name\u003d\'\"comment-\" + data:comment.id\'\>\u003c/a\> \u003cb:if cond\u003d\'data:comment.authorUrl\'\> \u003ca expr:href\u003d\'data:comment.authorUrl\' rel\u003d\'nofollow\'\>\u003cdata:comment.author\>\u003c/data:comment.author\>\u003c/a\> \u003cb:else\>\u003c/b:else\> \u003cdata:comment.author\>\u003c/data:comment.author\> \u003c/b:if\> \u003cdata:commentPostedByMsg\>\u003c/data:commentPostedByMsg\> \u003c/dt\> \u003cdd class\u003d\'comment-body\'\> \u003cb:if cond\u003d\'data:comment.isDeleted\'\> \u003cspan class\u003d\'deleted-comment\'\>\u003cdata:comment.body\>\u003c/data:comment.body\>\u003c/span\> \u003cb:else\>\u003c/b:else\> \u003cp\>\u003cdata:comment.body\>\u003c/data:comment.body\>\u003c/p\> \u003c/b:if\> \u003c/dd\> \u003cdd class\u003d\'comment-footer\'\> \u003cspan class\u003d\'comment-timestamp\'\> \u003ca expr:href\u003d\'\"#comment-\" + data:comment.id\' title\u003d\'comment permalink\'\> \u003cdata:comment.timestamp\>\u003c/data:comment.timestamp\> \u003c/a\> \u003cb:include data\u003d\'comment\' name\u003d\'commentDeleteIcon\'\>\u003c/b:include\> \u003c/span\> \u003c/dd\> \u003c/b:loop\> \u003c/dl\> \u003cp class\u003d\'comment-footer\'\> \u003ca expr:href\u003d\'data:post.addCommentUrl\' expr:onclick\u003d\'data:post.addCommentOnclick\'\>\u003cdata:postCommentMsg\>\u003c/data:postCommentMsg\>\u003c/a\> \u003c/p\> \u003c/b:if\> \u003cdiv id\u003d\'backlinks-container\'\> \u003cdiv expr:id\u003d\'data:widget.instanceId + \"_backlinks-container\"\'\> \u003cb:if cond\u003d\'data:post.showBacklinks\'\> \u003cb:include data\u003d\'post\' name\u003d\'backlinks\'\>\u003c/b:include\> \u003c/b:if\> \u003c/div\> \u003c/div\> \u003c/div\>'}, 'backlinks': {'varName': 'post', 'template': '\u003ca name\u003d\'links\'\>\u003c/a\>\u003ch4\>\u003cdata:post.backlinksLabel\>\u003c/data:post.backlinksLabel\>\u003c/h4\> \u003cb:if cond\u003d\'data:post.numBacklinks !\u003d 0\'\> \u003cdl class\u003d\'comments-block\' id\u003d\'comments-block\'\> \u003cb:loop values\u003d\'data:post.backlinks\' var\u003d\'backlink\'\> \u003cdiv class\u003d\'collapsed-backlink backlink-control\'\> \u003cdt class\u003d\'comment-title\'\> \u003cspan class\u003d\'backlink-toggle-zippy\'\>&#160;\u003c/span\> \u003ca expr:href\u003d\'data:backlink.url\' rel\u003d\'nofollow\'\>\u003cdata:backlink.title\>\u003c/data:backlink.title\>\u003c/a\> \u003cb:include data\u003d\'backlink\' name\u003d\'backlinkDeleteIcon\'\>\u003c/b:include\> \u003c/dt\> \u003cdd class\u003d\'comment-body collapseable\'\> \u003cdata:backlink.snippet\>\u003c/data:backlink.snippet\> \u003c/dd\> \u003cdd class\u003d\'comment-footer collapseable\'\> \u003cspan class\u003d\'comment-author\'\>\u003cdata:post.authorLabel\>\u003c/data:post.authorLabel\> \u003cdata:backlink.author\>\u003c/data:backlink.author\>\u003c/span\> \u003cspan class\u003d\'comment-timestamp\'\>\u003cdata:post.timestampLabel\>\u003c/data:post.timestampLabel\> \u003cdata:backlink.timestamp\>\u003c/data:backlink.timestamp\>\u003c/span\> \u003c/dd\> \u003c/div\> \u003c/b:loop\> \u003c/dl\> \u003c/b:if\> \u003cp class\u003d\'comment-footer\'\> \u003ca class\u003d\'comment-link\' expr:href\u003d\'data:post.createLinkUrl\' expr:id\u003d\'data:widget.instanceId + \"_backlinks-create-link\"\' target\u003d\'_blank\'\>\u003cdata:post.createLinkLabel\>\u003c/data:post.createLinkLabel\>\u003c/a\> \u003c/p\>'}, 'feedLinks': {'varName': '', 'template': '\u003cb:if cond\u003d\'data:blog.pageType !\u003d \"item\"\'\>  \u003cb:if cond\u003d\'data:feedLinks\'\> \u003cdiv class\u003d\'blog-feeds\'\> \u003cb:include data\u003d\'feedLinks\' name\u003d\'feedLinksBody\'\>\u003c/b:include\> \u003c/div\> \u003c/b:if\> \u003cb:else\>\u003c/b:else\>  \u003cdiv class\u003d\'post-feeds\'\> \u003cb:loop values\u003d\'data:posts\' var\u003d\'post\'\> \u003cb:if cond\u003d\'data:post.allowComments\'\> \u003cb:if cond\u003d\'data:post.feedLinks\'\> \u003cb:include data\u003d\'post.feedLinks\' name\u003d\'feedLinksBody\'\>\u003c/b:include\> \u003c/b:if\> \u003c/b:if\> \u003c/b:loop\> \u003c/div\> \u003c/b:if\>'}, 'feedLinksBody': {'varName': 'links', 'template': '\u003cdiv class\u003d\'feed-links\'\> \u003cdata:feedLinksMsg\>\u003c/data:feedLinksMsg\> \u003cb:loop values\u003d\'data:links\' var\u003d\'f\'\> \u003ca class\u003d\'feed-link\' expr:href\u003d\'data:f.url\' expr:type\u003d\'data:f.mimeType\' target\u003d\'_blank\'\>\u003cdata:f.name\>\u003c/data:f.name\> (\u003cdata:f.feedType\>\u003c/data:f.feedType\>)\u003c/a\> \u003c/b:loop\> \u003c/div\>'}, 'status-message': {'varName': '', 'template': '\u003cb:if cond\u003d\'data:navMessage\'\> \u003cdiv class\u003d\'status-msg-wrap\'\> \u003cdiv class\u003d\'status-msg-body\'\> \u003cdata:navMessage\>\u003c/data:navMessage\> \u003c/div\> \u003cdiv class\u003d\'status-msg-border\'\> \u003cdiv class\u003d\'status-msg-bg\'\> \u003cdiv class\u003d\'status-msg-hidden\'\>\u003cdata:navMessage\>\u003c/data:navMessage\>\u003c/div\> \u003c/div\> \u003c/div\> \u003c/div\> \u003cdiv style\u003d\'clear: both;\'\>\u003c/div\> \u003c/b:if\>'}}, document.getElementById('Blog1'), {}, 'displayModeFull'));
</script>
</body>
</html>