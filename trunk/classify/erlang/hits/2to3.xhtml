<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">

<head>
<meta charset="utf-8"/>
<title>Sam Ruby: 2to3</title>
<link rel="alternate" type="application/atom+xml" title="2to3" href="http://intertwingly.net/blog/2653.atom"/>
<link rel="stylesheet" href="/css/blog3.css" type="text/css" media="screen"/>
<link rel="stylesheet" href="/css/print.css" type="text/css" media="print"/>
<link rel="shortcut icon" href="/favicon.ico"/>
<meta name="ICBM" content="35.708298,-78.695515"/>
<script type="text/javascript" src="/js/comment_form.js"></script>
<script type="text/javascript" src="/js/localize_dates.js"></script>
</head>

<body id="intertwingly-net" onload="initCommentForm(document.getElementById('comments_form'))">

<div class="banner">
<h1><a class="banner-anchor" href="http://intertwingly.net/blog/">intertwingly</a></h1>
<form method="get" action="http://intertwingly.net/blog/">
<label for="q">Search</label>
<input type="text" size="12" name="q" value=""/>
</form>
<p>It&#8217;s just data</p>
</div>

<div class="content">
<h3><a href="http://intertwingly.net/blog/2007/09/01/2to3">2to3</a>
<hr/><time title="GMT" datetime="2007-09-02T02:07:07Z">Sun 02 Sep 2007 at 02:07</time></h3>
<div class="blogbody">
<div style="width:6.25em; height:6.25em; float:right"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 100 100">
  <defs>
    <linearGradient id="pyYellow" gradientTransform="rotate(45)">
      <stop stop-color="#fe5" offset="0.6"/>
      <stop stop-color="#da1" offset="1"/>
    </linearGradient>
    <linearGradient id="pyBlue" gradientTransform="rotate(45)">
      <stop stop-color="#69f" offset="0.4"/>
      <stop stop-color="#468" offset="1"/>
    </linearGradient>
  </defs>

  <path d="M27,16c0-7,9-13,24-13c15,0,23,6,23,13l0,22c0,7-5,12-11,12l-24,0c-8,0-14,6-14,15l0,10l-9,0c-8,0-13-9-13-24c0-14,5-23,13-23l35,0l0-3l-24,0l0-9l0,0z M88,50v1" fill="url(#pyBlue)"/>
  <path d="M74,87c0,7-8,13-23,13c-15,0-24-6-24-13l0-22c0-7,6-12,12-12l24,0c8,0,14-7,14-15l0-10l9,0c7,0,13,9,13,23c0,15-6,24-13,24l-35,0l0,3l23,0l0,9l0,0z M140,50v1" fill="url(#pyYellow)"/>

  <circle r="4" cx="64" cy="88" fill="#FFF"/>
  <circle r="4" cx="37" cy="15" fill="#FFF"/>
</svg></div>
<p>As a learning exercise, I tried converting the <a href="http://feedparser.org/">Universal Feed Parser</a> to Python 3.0.&#160; I picked it because it is a relatively self contained code base that I am familiar with, one that is actively in use, and one that has seen the wear and tear of dealing with compatibility (and the need to monkeypatch the occasional bug) of a number of Python releases.</p>
<pre class="code">$ svn co <a href="http://svn.python.org/projects/sandbox/trunk/2to3/">http://svn.python.org/projects/sandbox/trunk/2to3/</a>
$ cd 2to3

$ python refactor.py -w ../feedparser/feedparser.py &gt; <a href="http://intertwingly.net/stories/2007/09/01/feedparser.2to3.diff">feedparser.2to3.diff</a>
root: Generating grammar tables from /home/rubys/svn/2to3/PatternGrammar.txt
root: Writing grammar tables to /home/rubys/svn/2to3/PatternGrammar.pickle
../feedparser/feedparser.py: At line 3091: You should use a for loop here
RefactoringTool: Files that were modified:
RefactoringTool: ../feedparser/feedparser.py

$ python refactor.py -w ../feedparser/feedparsertest.py &gt; <a href="http://intertwingly.net/stories/2007/09/01/feedparsertest.2to3.diff">feedparsertest.2to3.diff</a>
RefactoringTool: Files that were modified:
RefactoringTool: ../feedparser/feedparsertest.py</pre>
<p>A few <a href="http://intertwingly.net/stories/2007/09/01/feedparser.manual.diff">manual</a> <a href="http://intertwingly.net/stories/2007/09/01/feedparsertest.manual.diff">changes</a> later, and 91% of the tests pass.&#160; I&#8217;m confident that with a little more work, I could quickly get that to 99%, perhaps even to 100%.</p>
<h3 id="good">The Good</h3>
<ul>
<li>Python 3.0 feels very natural and comfortable, at least to this Python programmer.&#160; The language feels clean and new again.&#160; No more &#8220;new-style&#8221; classes.&#160; Things that should have been iteraters all along now are.&#160; Python 3.0 is full of those kind of small changes.</li>
<li>No bugs were found in the language, though some minor issues (noted below) were found in various parts of the runtime.</li>
<li>The <code>2to3</code> conversion, even at this first alpha sandbox state, was painless and efficient.&#160; It also didn&#8217;t reduce the readability or break the functionality of the code produced.</li>
<li>The places where manual attention is required did generally seem to be places where human attention is required.</li>
</ul>

<h3 id="bad">The Bad</h3>
<ul>
<li>The Unicode change (while *<b>VERY</b>* welcome) is going to hit people hard.&#160; While the UFP code has greater than its fair share of such code, the fact that people will no longer simply be able to <code>open(file).read()</code> unless that file is <code>utf-8</code> is going to be a big shock.</li>
<li>Some of the python3 libraries don&#8217;t seem to have internalized the Unicode changes yet.&#160; <code>base64.decodestring</code> can only handle <code>bytes</code>, not characters (why?).  More troublesome to me is that I couldn't get <code>xml.sax.xmlreader.InputSource</code> to work with a <code>io.BytesIO</code> (a <code>StringIO</code> work-alike for <code>bytes</code>), but instead only seemed to work with Characters &#8212; something that is at odds with proper handling of XML.&#160; However, I do realize that this is an alpha, and fully believe that these issues will be worked out.</li>
<li>The test code for UFP relies on <code>eval</code>, and some portion of those strings &#8212; ones that can never be automatically handled by a <code>2to3</code> migration tool &#8212; rely on Python 2.x specific syntax.&#160; Ultimately it might be worth considering introducing an <code>python2</code> module with functions like <code>eval</code> that can be used to ease migration.</li>
<li>The places that the <code>2to3</code> migration tool can&#8217;t currently handle, and perhaps never will be able to handle, will often require somebody who has an understanding and a history with the code base.&#160; Such people aren&#8217;t always available.&#160; I&#8217;m not sure what can be done about that.</li>
</ul>

<h3 id="ugly">The Ugly</h3>
<ul>
<li>3.0 will only get better.&#160; I&#8217;m highly confident that the issues listed above will be either eliminated or mitigated.&#160; The one question that this exercise raised for me that I can&#8217;t seem to shake is this: what is the role of 2.6?&#160; If it introduces new stuff that makes the migration easier, I can&#8217;t see libraries like the feedparser making much use of them until it is 2.5 and 2.4 and even earlier versions of Pythons are pretty much a thing of the past.&#160; I&#8217;m sure I&#8217;m missing something here, but I just don&#8217;t see it.</li>
</ul>

<!--
  <rdf:RDF xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
	   xmlns:trackback="http://madskills.com/public/xml/rss/module/trackback/"
	   xmlns:dc="http://purl.org/dc/elements/1.1/">
    <rdf:Description
      rdf:about="http://intertwingly.net/blog/2653.rdf"
      trackback:ping="http://intertwingly.net/blog/2653.tb"
      dc:title="2to3"
      dc:identifier="http://intertwingly.net/blog/2007/09/01/2to3" />
  </rdf:RDF>
-->
</div>
<div class="ad">
<script type="text/javascript"><!--
google_ad_client = "pub-7627325548543983";
google_ad_width = 468;
google_ad_height = 60;
google_ad_format = "468x60_as";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</div>

<a id="comments"/>
<h2><time title="GMT" datetime="2007-09-02">Sun 02 Sep 2007</time></h2>
<div class="comment">
<hr/>
<a id="c1188711911"></a>
<h3>Sam Ruby on python 3</h3>
<a rel="nofollow" href="http://intertwingly.net/blog/2007/09/01/2to3">[link]</a>...
<br /><br />Excerpt from <a href="http://del.icio.us/url/0279b84bea69ae612e553281c9031606">del.icio.us/tag/python</a>
 at
<a href="http://intertwingly.net/blog/2007/09/01/2to3#c1188711911"><time title="GMT" datetime="2007-09-02T05:45:11Z">05:45</time></a>
</div>

<div class="comment">
<hr/>
<a id="c1188728115"></a>
<h3>Imperfection - Martin Jansen</h3>
Last Friday, Guido van Rossum released the first alpha version of Python 3.0 aka Python 3000 . Judging by the changelog , the Python developers got rid of a number of annoyances and inconsistencies in order to make the language more cleaner...
<br /><br />Excerpt from <a href="http://martinjansen.com/2007/09/imperfection/">Planet PHP</a>
 at
<a href="http://intertwingly.net/blog/2007/09/01/2to3#c1188728115"><time title="GMT" datetime="2007-09-02T10:15:15Z">10:15</time></a>
</div>

<div class="comment">
<hr/>
<a id="c1188728656"></a>
How would one do a &lt;code&gt;open(file).read()&lt;/code&gt; where file is a non-unicode file in 3000?
<br />
<br />
Posted by <a href="http://henriklied.no" title="static243-190-166.adsl.no">Henrik Lied</a> at
<a href="http://intertwingly.net/blog/2007/09/01/2to3#c1188728656"><time title="GMT" datetime="2007-09-02T10:24:16Z">10:24</time></a>
</div>

<div class="comment">
<hr/>
<a id="c1188732886"></a>
<pre class="code">import codecs
codecs.open(file,'r',encoding).read()</pre>
Posted by <a class="openid" href="http://intertwingly.net/blog/" title="http://intertwingly.net/id/">Sam Ruby</a>
 at
<a href="http://intertwingly.net/blog/2007/09/01/2to3#c1188732886"><time title="GMT" datetime="2007-09-02T11:34:46Z">11:34</time></a>
</div>

<div class="comment">
<hr/>
<a id="c1188748454"></a>
<p>I probably should mention that as ASCII is a proper subset of utf-8, <code>open(file).read()</code> will likely work for most of your test data and wait to fail until after you deploy, probably as a result of somebody copy/pasting so-called <a href="http://www.intertwingly.net/stories/2004/04/14/i18n.html#CleaningWindows">&#8220;smart quotes&#8221;</a>.</p>
<p>Also, <code>open(file,"rb").read()</code> will return raw bytes.</p>
Posted by <a class="openid" href="http://intertwingly.net/blog/" title="http://intertwingly.net/id/">Sam Ruby</a> at
<a href="http://intertwingly.net/blog/2007/09/01/2to3#c1188748454"><time title="GMT" datetime="2007-09-02T15:54:14Z">15:54</time></a>
</div>

<h2><time title="GMT" datetime="2007-09-03">Mon 03 Sep 2007</time></h2>
<div class="comment">
<hr/>
<a id="c1188782115"></a>
<h3>Sam Ruby: 2to3</h3>
Sam Ruby: 2to3 . Sam&#8217;s report on an attempt to port the Universal Feed Parser to Python 3.0. The 2to3 tool does most of the work, but it seems the unicode changes can be pretty tricky....
<br /><br />Excerpt from <a href="http://simonwillison.net/2007/Sep/3/sam/">Simon Willison's Weblog</a>
 at
<a href="http://intertwingly.net/blog/2007/09/01/2to3#c1188782115"><time title="GMT" datetime="2007-09-03T01:15:15Z">01:15</time></a>
</div>

<div class="comment">
<hr/>
<a id="c1188782120"></a>
<h3>Sam Ruby: 2to3</h3>
Sam Ruby: 2to3 . Sam&#8217;s report on an attempt to port the Universal Feed Parser to Python 3.0. The 2to3 tool does most of the work, but it seems the unicode changes can be pretty tricky....
<br /><br />Excerpt from <a href="http://feeds.feedburner.com/~r/pythonlovers/~3/151426866/">PythonLovers.com</a>
 at
<a href="http://intertwingly.net/blog/2007/09/01/2to3#c1188782120"><time title="GMT" datetime="2007-09-03T01:15:20Z">01:15</time></a>
</div>

<div class="comment">
<hr/>
<a id="c1188787527"></a>
<h3>Sam Ruby's report on porting the Universal Feed Parser to Python 3.0 using the 2to3 conversion tool</h3>
[link] [more]...
<br /><br />Excerpt from <a href="http://programming.reddit.com/info/2l7h4/comments">reddit.com: programming - newest submissions</a>
 at
<a href="http://intertwingly.net/blog/2007/09/01/2to3#c1188787527"><time title="GMT" datetime="2007-09-03T02:45:27Z">02:45</time></a>
</div>

<div class="comment">
<hr/>
<a id="c1188787531"></a>
<h3>Sam Ruby: 2to3</h3>
Simon Willison : Sam Ruby: 2to3 - Sam Ruby: 2to3. Sam&#8217;s report on an attempt to port the Universal Feed Parser to Python 3.0. The 2to3 tool does most of the work, but it seems the unicode changes can be pretty tricky....
<br /><br />Excerpt from <a href="http://dev.upian.com/hotlinks/archives/2007/09/03/#item78960">HotLinks - Level 1</a>
 at
<a href="http://intertwingly.net/blog/2007/09/01/2to3#c1188787531"><time title="GMT" datetime="2007-09-03T02:45:31Z">02:45</time></a>
</div>

<div class="comment">
<hr/>
<a id="c1188792910"></a>
<h3>La alpha 1 di Python 3000</h3>
Scopro dal blog di Guido van Rossum che ieri &#232; stata rilasciata la 3.0a1 di Python &#8211; famoso e amato linguaggio di programmazione multiparadigma*. Su python.org (sito ufficiale) trovate la pagina della release. E&#8217; inoltre disponibile...
<br /><br />Excerpt from <a href="http://www.webdomus.it/tao/?p=956">Il Tao dei blog</a>
 at
<a href="http://intertwingly.net/blog/2007/09/01/2to3#c1188792910"><time title="GMT" datetime="2007-09-03T04:15:10Z">04:15</time></a>
</div>

<div class="comment">
<hr/>
<a id="c1188818531"></a>
<blockquote><p>The one question that this exercise raised for me that I can&#8217;t seem to shake is this: what is the role of 2.6? </p></blockquote>
<p>Sure, it&#8217;s about migration. The process description is such that all code shall be adapted in Python 2.6 with appropriate hints and none in Python 3.0. Together with these hints the conversion process shall become fully automized. I didn&#8217;t examine 2to3 yet and I&#8217;m not sure how the the user provides hints to the conversion tool. It might even be that Python 2.6 introduces new language syntax for this purpose only.</p>
Posted by <a rel="nofollow" href="mailto:kay@fiber-space.de" title="dslb-088-064-022-084.pools.arcor-ip.net">Kay Schluehr</a> at
<a href="http://intertwingly.net/blog/2007/09/01/2to3#c1188818531"><time title="GMT" datetime="2007-09-03T11:22:11Z">11:22</time></a>
</div>

<div class="comment">
<hr/>
<a id="c1188825449"></a>
<blockquote class="quote"><p>The process description is such that all code shall be adapted in Python 2.6 with appropriate hints and none in Python 3.0.
</p></blockquote>
<p>This works well for top level applications, but not so well for library developers for which the library is not part of Python itself.&#160; Specifically, it would require a number of libraries I depend upon (e.g., <a href="http://code.google.com/p/httplib2/">httplib2</a>, <a href="http://code.google.com/p/feedparser/">feedparser</a>, <a href="http://code.google.com/p/html5lib/">html5lib</a>) to stop supporting Python 2.5.</p>
Posted by <a class="openid" href="http://intertwingly.net/blog/" title="http://intertwingly.net/id/">Sam Ruby</a>
 at
<a href="http://intertwingly.net/blog/2007/09/01/2to3#c1188825449"><time title="GMT" datetime="2007-09-03T13:17:29Z">13:17</time></a>
</div>

<h2><time title="GMT" datetime="2007-09-15">Sat 15 Sep 2007</time></h2>
<div class="comment">
<hr/>
<a id="c1189831509"></a>
<h3>4 Sep 2007</h3>
Sam Ruby tryied to port the Univesal Feed Parser to Py3k. 91% of the tests pass, what is quite nice. UFP is a great piece of code, and one of the first things I would miss. PyGTK people started talking about the migration - this will be very...
<br /><br />Excerpt from <a href="http://www.advogato.org/person/eopadoan/diary.html?start=3">Advogato blog for eopadoan</a>
 at
<a href="http://intertwingly.net/blog/2007/09/01/2to3#c1189831509"><time title="GMT" datetime="2007-09-15T04:45:09Z">04:45</time></a>
</div>

<div class="commentform">
<h2>Add your comment</h2>
<a id="commentForm"></a>
<form method="post" action="http://intertwingly.net/blog/2007/09/01/2to3" accept-charset="utf-8"
  id="comments_form" onsubmit="if (this.bakecookie.checked) rememberMe(this)">
<div class="comment">
<input name="parent" type="hidden" value="2653"/>
<input name="title" type="hidden" value="2to3"/>
<label for="name">Name:</label><br/>
<input maxlength="50" id="name" name="name" size="75" type="text" value=""/><br/>
<br/>
<label for="email">E-mail:</label><br/>
<input maxlength="75" id="email" name="email" size="75" type="text" value=""/><br/>
<br/>
<label for="url">URI:</label><br/>
<input maxlength="100" id="url" name="url" size="75" type="text" value=""/><br/>
<br/>
<label for="comment">Comment:</label><br/>
<textarea cols="59" id="comment" name="comment" rows="12"></textarea>
<br/>
<input name="preview" type="submit" value="Preview"/>
<input type="button" onclick="forgetMe(this.form)" value="Clear Info"/>
<input type="checkbox" name="bakecookie" id="bakecookie"/>
<label for="bakecookie">Remember info?</label>
</div>
</form>

</div>
</div>

<div class="rightbar">

<h2>Nav Bar</h2>

<div class="navbar">
<ul>
<li><a href="http://en.wikipedia.org/wiki/Sam_Ruby">About</a></li>
<li><a href="/blog/comments.html">Comments</a></li>
<li><a href="/stats/">Statistics</a></li>
<li><a href="/blog/archives/">Archives</a></li>
<li><a href="http://planet.intertwingly.net/">BlogRoll</a></li>
<li><a href="/wiki/pie/FrontPage">Wiki</a></li>
<li><a href="/code/">Code</a></li>
<li><a href="http://www.oreilly.com/catalog/9780596529260/">Book</a></li>
<li><a href="/blog/2005/05/16/Disclaim-This">Disclaimer</a></li>
</ul>
</div>

</div>

<div class="rightbar2">
<div>
<script type="text/javascript"><!--
google_ad_client = "pub-7627325548543983";
google_ad_width = 125;
google_ad_height = 125;
google_ad_format = "125x125_as_rimg";
google_cpa_choice = "CAAQ5-WZzgEaCDRYqcloyjDbKK2293M";
//--></script>
<script type="text/javascript" src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</div>
</div>

</body>
</html>
