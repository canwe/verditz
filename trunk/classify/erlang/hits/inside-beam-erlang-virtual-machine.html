<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>Erlang for .NET: Inside BEAM, the Erlang Virtual Machine</title>

  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="MSSmartTagsPreventParsing" content="true" />
<meta name="generator" content="Blogger" />
<link rel="alternate" type="application/atom+xml" title="Erlang for .NET - Atom" href="http://erlangdotnet.net/atom.xml" />
<link rel="alternate" type="application/rss+xml" title="Erlang for .NET - RSS" href="http://erlangdotnet.net/rss.xml" />
<link rel="service.post" type="application/atom+xml" title="Erlang for .NET - Atom" href="http://www.blogger.com/feeds/5061189310503801533/posts/default" />
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://www.blogger.com/rsd.g?blogID=5061189310503801533" />
<link rel="alternate" type="application/atom+xml" title="Erlang for .NET - Atom" href="http://erlangdotnet.net/atom.xml" />
<style type="text/css">
@import url("http://www.blogger.com/css/blog_controls.css");
@import url("http://www.blogger.com/dyn-css/authorization.css?blogID=5061189310503801533");
</style>



  <style type="text/css">


/* 
Blogger Template Style
Name:     TicTac (Blueberry)
Author:   Dan Cederholm
URL:      www.simplebits.com
Date:     1 March 2004
*/

/* ---( page defaults )--- */

body {
  margin: 0;
  padding: 0;
  font-family: Verdana, sans-serif;
  font-size: small;
  text-align: center;
  color: #333;
  background: #e0e0e0;
  }

blockquote {
  margin: 0 0 0 30px;
  padding: 10px 0 0 20px;
  font-size: 88%;
  line-height: 1.5em;
  color: #666;
  background: url(http://www.blogblog.com/tictac_blue/quotes.gif) no-repeat top left;
  }

blockquote p {
  margin-top: 0;
  }

abbr, acronym {
  cursor: help;
  font-style: normal;
  border-bottom: 1px dotted;
  }

code {
  color: #996666;
  }

hr {
  display: none;
  }

img {
  border: none;
  }

/* unordered list style */

ul {
  list-style: none;
  margin: 0 0 20px 30px;
  padding: 0;
  }

li {
  list-style: none;
  padding-left: 14px;
  margin-bottom: 3px;
  background: url(http://www.blogblog.com/tictac_blue/tictac_blue.gif) no-repeat 0 6px;
  }

/* links */

a:link {
  color: #6699cc;
  }

a:visited {
  color: #666699;
  }

a:hover {
  color: #5B739C;
  }

a:active {
  color: #5B739C;
  text-decoration: none;
  }

/* ---( layout structure )---*/

@media all {
  #wrap {
    width: 847px;
    margin: 0 auto;
    text-align: left;
    background: url(http://www.blogblog.com/tictac_blue/tile.gif) repeat-y;
    }

  #content {
    margin-left: 62px; /* to avoid the BMH */
    }

  #main-content {
    float: left;
    width: 460px;
    margin: 20px 0 0 0;
    padding: 0;
    line-height: 1.5em;
    }

  #sidebar {
    margin: 0 41px 0 547px;
    padding: 20px 0 0 0;
    font-size: 85%;
    line-height: 1.4em;
    color: #999;
    background: url(http://www.blogblog.com/tictac_blue/sidebar_bg.gif) no-repeat 0 0;
    }
  }
@media handheld {
  #wrap {
    width: 90%;
    background: none;
    }

  #content {
    margin-left: 0 2% 0 2%;
    }

  #main-content {
    float: none;
    width: 100%;
    }

  #sidebar {
    margin: 0 2% 0 2%;
    }
  }

/* ---( header and site name )--- */

@media all {
  #blog-header {
    margin: 0;
    padding: 0;
    font-family: "Lucida Grande", "Trebuchet MS";
    background: #e0e0e0 url(http://www.blogblog.com/tictac_blue/top_div_blue.gif) no-repeat top left;
    }

  #blog-header h1 {
    margin: 0;
    padding: 45px 60px 50px 160px;
    font-size: 200%;
    color: #fff;
    text-shadow: #4F73B6 2px 2px 2px;
    background: url(http://www.blogblog.com/tictac_blue/top_h1_blue.gif) no-repeat bottom left;
    }
  }
@media handheld {
  #blog-header {
    background: #6699cc;
    }

  #blog-header h1 {
    background: none;
    }
  }

#blog-header h1 a {
  text-decoration: none;
  color: #fff;
  }

#blog-header h1 a:hover {
  color: #eee;
  }

/* ---( main column )--- */

h2.date-header {
  margin-top: 0;
  padding-left: 14px;
  font-size: 90%;
  color: #999999;
  background: url(http://www.blogblog.com/tictac_blue/date_icon_blue.gif) no-repeat 0 50%;
  }

h3.post-title {
  margin-top: 0;
  font-family: "Lucida Grande", "Trebuchet MS";
  font-size: 130%;
  letter-spacing: -1px;
  color: #993333;
  }

.post {
  margin: 0 0 1.5em 0;
  padding: 0 0 1.5em 14px;
  border-bottom: 1px solid #ddd;
  }

.post-footer {
  margin: 0;
  padding: 0 0 0 14px;
  font-size: 88%;
  color: #999;
  background: url(http://www.blogblog.com/tictac_blue/tictac_grey.gif) no-repeat 0 8px;
  }

.post img {
  padding: 6px;
  border-top: 1px solid #ddd;
  border-left: 1px solid #ddd;
  border-bottom: 1px solid #c0c0c0;
  border-right: 1px solid #c0c0c0;
  }

/* comment styles */

#comments {
  padding-top: 10px;
  font-size: 85%;
  line-height: 1.5em;
  color: #666;
  background: #eee url(http://www.blogblog.com/tictac_blue/comments_curve.gif) no-repeat top left;
  }

#comments h4 {
  margin: 20px 0 15px 0;
  padding: 8px 0 0 40px;
  font-family: "Lucida Grande", "Trebuchet MS";
  font-size: 130%;
  color: #666;
  background: url(http://www.blogblog.com/tictac_blue/bubbles.gif) no-repeat 10px 0;
  height: 29px !important; /* for most browsers */
  height /**/:37px; /* for IE5/Win */
  }
  
#comments ul {
  margin-left: 0;
  }

#comments li {
  background: none;
  padding-left: 0;
  }
  
.comment-body {
  padding: 0 10px 0 25px;
  background: url(http://www.blogblog.com/tictac_blue/tictac_blue.gif) no-repeat 10px 5px;
  }

.comment-body p {
  margin-bottom: 0;
  }

.comment-data {
  margin: 4px 0 0 0;
  padding: 0 10px 1em 60px;
  color: #999;
  border-bottom: 1px solid #ddd;
  background: url(http://www.blogblog.com/tictac_blue/comment_arrow_blue.gif) no-repeat 44px 2px;
  }

.deleted-comment {
  font-style:italic;
  color:gray;
  }

/* ---( sidebar )--- */

h2.sidebar-title {
  margin: 0 0 0 0;
  padding: 25px 0 0 50px;
  font-family: "Lucida Grande", "Trebuchet MS";
  font-size: 130%;
  color: #666;
  height: 32px;
  background: url(http://www.blogblog.com/tictac_blue/sidebar_icon.gif) no-repeat 20px 15px;
  height: 32px !important; /* for most browsers */
  height /**/:57px; /* for IE5/Win */
  }

#sidebar ul, #sidebar p {
  margin: 0;
  padding: 5px 20px 1em 20px;
  border-bottom: 1px solid #ddd;
  }

#sidebar li {
  background: url(http://www.blogblog.com/tictac_blue/tictac_blue.gif) no-repeat 0 5px;
  }

/* profile block */

.profile-datablock {
  margin: 0;
  padding: 5px 20px 0 20px;
  }

.profile-datablock dd {
  margin: 0;
  padding: 0;
  }

.profile-img img {
  float: left;
  margin: 0 10px 0 0;
  padding: 4px;
  border-top: 1px solid #ddd;
  border-left: 1px solid #ddd;
  border-bottom: 1px solid #c0c0c0;
  border-right: 1px solid #c0c0c0;
  background: #fff;
  }

#sidebar p.profile-link {
  padding-left: 36px;
  background: url(http://www.blogblog.com/tictac_blue/profile_blue.gif) no-repeat 20px 4px;
  }

p#powered-by, #sidebar p.profile-textblock {
  margin-top: 1em;
  border: none;
  }

/* ---( footer )--- */

.clear { /* to fix IE6 padding-top issue */
  clear: both;
  height: 0;
  }

@media all {
  #footer {
    margin: 0;
    padding: 0 0 9px 0;
    font-size: 85%;
    color: #ddd;
    background: url(http://www.blogblog.com/tictac_blue/bottom_sill.gif) no-repeat bottom left;
    }

  #footer p {
    margin: 0;
    padding: 20px 320px 20px 95px;
    background: url(http://www.blogblog.com/tictac_blue/bottom_sash.gif) no-repeat top left;
    }
  }
@media handheld {
  #footer {
    background: none;
    }

  #footer p {
    background: none;
    }
  }


/* ---- overrides for post page ---- */

.post {
  padding: 0;
  border: none;
  }



/* Feeds
----------------------------------------------- */
#blogfeeds {
  }
#postfeeds {
  }
  </style>


</head>

<body>

<div id="wrap"> <!-- #wrap - for centering -->

<!-- Blog Header -->
<div id="blog-header">
  <h1>
    <a href="http://erlangdotnet.net/">
	Erlang for .NET
	</a>
  </h1>
</div>


<div id="content"> <!-- #content wrapper -->

<!-- Begin #main-content -->
<div id="main-content">



    
  <h2 class="date-header">Wednesday, September 19, 2007</h2>
  
  
     
  <!-- Begin .post -->
  <div class="post"><a name="1089885530019630382"></a>
     
    
    <h3 class="post-title">
	 
	 Inside BEAM, the Erlang Virtual Machine
	 
    </h3>
    
     
    <div class="post-body">
    
      <p><div style="clear:both;"></div><div>OTP R11B-5 includes more than one million lines of Erlang. The kernel and standard library are about a third of these lines. The emulator, BEAM, is around 200,000 lines of C.</div><div><br /></div><div>BEAM's C <span class="Apple-style-span" style="font-style: italic;">main</span> functions are platform-specific and live in <span class="Apple-style-span" style="font-style: italic; ">erts/emulator/sys/unix, win32,</span> and so on. (Windows actually has two <span class="Apple-style-span" style="font-style: italic; ">mains:</span> a simple one similar to the Unix entrypoints in <span class="Apple-style-span" style="font-style: italic; ">erl_main.c,</span> and a more complex one in <span class="Apple-style-span" style="font-style: italic; ">erl_main_sae.c</span> which is used in bootstrapping the toolchain.) The conventional <span class="Apple-style-span" style="font-style: italic; ">mains</span> immediately call <span class="Apple-style-span" style="font-style: italic; ">erl_start</span> which processes command line arguments, copies <span class="Apple-style-span" style="font-style: italic; ">argv</span> into a list of strings, creates a process and runs <span class="Apple-style-span" style="font-style: italic; ">otp_ring0</span> with the argument list. <span class="Apple-style-span" style="font-style: italic;">otp_ring0</span> looks up and runs <span class="Apple-style-span" style="font-style: italic; ">init:boot/1.</span> There is more initialization after this, but from <span class="Apple-style-span" style="font-style: italic; ">otp_ring0</span> on, apart from some built-in functions, Erlang is implemented in Erlang. </div><div><br /></div><div>In practice, the Erlang compiler (another 30,000 lines of Erlang) compiles Erlang to BEAM bytecodes. When <span class="Apple-style-span" style="font-style: italic;">erl_start</span> runs <span class="Apple-style-span" style="font-style: italic;">otp_ring0</span> and so on, it is loading BEAM binaries generated by the Erlang compiler earlier. The BEAM instruction set is register-based and has 130 instructions. These include instructions for arithmetic, comparsions and boolean logic; manipulating strings, tuples and lists; stack and heap allocation and freeing; type tests for Erlang primitives (numbers, lists, process IDs, references, and so on);  jumps, structured exception handling, and calls and returns; sending messages and reading from the process' mailbox; waiting and timeouts; and so on. The instructions are listed in <span class="Apple-style-span" style="font-style: italic;">lib/compiler/src/beam_opcodes.erl.</span> In BEAM, <span class="Apple-style-span" style="font-style: italic;">erts/emulator/beam/ops.tab</span> contains rewrite rules that map typed BEAM instructions into emulator internals. A Perl script (<span class="Apple-style-span" style="font-style: italic;">beam_makeops</span>) translates this file into C code (mostly macros.)</div><div><br /></div><div>Some Erlang built-in function (BIFs) calls are translated into an extended instruction set not generated by the compiler. For example, the BIF <span class="Apple-style-span" style="font-style: italic;">erlang:self/3</span> is rewritten as a single 'self' instruction. Other BIF linkage is via a set of instructions for calling BIFs of varying arities. <span class="Apple-style-span" style="font-style: italic;">erts/emulator/beam/bif.tab</span> maps BIF labels into C externs. For example, calls to the BIF <span class="Apple-style-span" style="font-style: italic;">erlang:spawn/3</span> boil down to a call to <span class="Apple-style-span" style="font-style: italic;">spawn_3</span> (found in <span class="Apple-style-span" style="font-style: italic;">erts/emulator/bif.c</span>),<span class="Apple-style-span" style="font-style: italic;"> </span>which in turn thunks to <span class="Apple-style-span" style="font-style: italic;">erl_create_process.</span></div><div><span class="Apple-style-span" style="font-style: italic;"><br /></span></div><div><span class="Apple-style-span" style="font-style: italic;"><span class="Apple-style-span" style="font-style: normal; ">Incidentally, processes are not related to threads or operating system processes. Instead, BEAM maintains queues of processes that are scheduled to run. There is one queue per priority level.</span> <span class="Apple-style-span" style="font-style: normal;">Schedulers</span><span class="Apple-style-span" style="font-style: normal;"> pick processes from the queues and run them. Processes maintain their registers and a pointer to the next instruction to execute.</span><br /></span></div><div><span class="Apple-style-span" style="font-style: italic;"><br /></span></div><div>The garbage collector, in <span class="Apple-style-span" style="font-style: italic;">erts/emulator/beam/erl_gc.c,</span> is a mark-and-sweep copying collector. The most interesting thing about the BEAM garbage collector is that the garbage collected heaps are per-process. BEAM can do this because Erlang processes communicate explicitly via messages, and not via mutating shared memory. The CLR, in contrast, divides heaps into generations protected by write barriers and does incremental collection to avoid having to garbage collect all of a program's heap at the same time. This extra complexity is part of the price of using a shared heap to communicate between threads in the CLR.</div><div style="clear:both; padding-bottom:0.25em"></div></p>
    
    </div>
    
    <p class="post-footer">posted by Kappuccino Kid at 
    <a class="post-footer-link" href="http://erlangdotnet.net/2007/09/inside-beam-erlang-virtual-machine.html" title="permanent link"> 10:35 PM </a>
       <span class="item-control blog-admin pid-879229588"><a style="border:none;" href="http://www.blogger.com/post-edit.g?blogID=5061189310503801533&postID=1089885530019630382" title="Edit Post"><span class="quick-edit-icon">&nbsp;</span></a></span></p>
  
  </div>
  <!-- End .post -->
  
  
   <!-- Begin #comments -->
 

  <div id="comments">

	<a name="comments"></a>
    
    <h4>0 Comments:</h4>
    
    <ul>
      
    </ul>
	
	<p class="comment-data">
    <a class="comment-link" href="http://www.blogger.com/comment.g?blogID=5061189310503801533&postID=1089885530019630382">Post a Comment</a>
    <p id="postfeeds"></p>
    <br /><br />

		    
    



	<a href="http://erlangdotnet.net/">&lt;&lt; Home</a>
    </p>
    </div>
  

  <!-- End #comments -->



  <hr />
</div><!-- End #main-content -->
</div><!-- End #content -->



<!-- Begin #sidebar -->
<div id="sidebar">

  <h2 class="sidebar-title">About</h2>
  
  <p>I'm writing an <a href="http://erlang.org/">Erlang</a> compiler for <a href="http://msdn.microsoft.com/netframework">.NET.</a> What fun!</p>
  
   <!-- Begin #profile-container -->
   
   <div id="profile-container"><h2 class="sidebar-title">About Me</h2>
<dl class="profile-datablock">
<dd class="profile-data"><strong>Name:</strong>  Kappuccino Kid </dd>
</dl>

<p class="profile-link"><a href="http://www.blogger.com/profile/06396924482008994484">View my complete profile</a></p></div>
   
  <!-- End #profile -->
    
        
  
  <h2 class="sidebar-title">Previous</h2>
  
  <ul id="recently">
    
        <li><a href="http://erlangdotnet.net/2007/09/stranger-bedfellows-erlang-and-dynamic.html">Stranger Bedfellows: Erlang and the Dynamic Langua...</a></li>
     
        <li><a href="http://erlangdotnet.net/2007/09/erlang-and-net-strange-bedfellows.html">Erlang and .NET: Strange bedfellows?</a></li>
     
  </ul>
  
  
  
  <!--<h2 class="sidebar-title">New</h2>
  
  <p>This is a paragraph of text in the sidebar.</p>
  -->
  
  <p id="powered-by"><a href="http://www.blogger.com"><img src="http://buttons.blogger.com/bloggerbutton1.gif" alt="Powered by Blogger" /></a></p>
  <p id="blogfeeds">Subscribe to<br/>Posts [<a target="_blank" href="http://erlangdotnet.net/atom.xml" type="application/atom+xml">Atom</a>]</p>


</div>
<!-- End #sidebar -->

<div class="clear">&nbsp;</div>

<div id="footer">
   <p><!-- If you'd like, you could place footer information here. -->&nbsp;</p>
</div>

</div> <!-- end #wrap -->

<!-- c(~) -->

<script src="http://www.google-analytics.com/urchin.js" type="text/javascript">
</script>
<script type="text/javascript">
_uacct = "UA-1987481-1";
urchinTracker();
</script>

</body>
</html>